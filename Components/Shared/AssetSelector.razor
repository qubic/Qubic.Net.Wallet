@inject AssetRegistryService Registry

<div class="mb-2">
    <label class="form-label small">@IssuerLabel</label>
    <div class="input-group input-group-sm">
        <input class="form-control form-control-sm mono @IdentityValidation.CssClass(IssuerValue)"
               list="@_issuerListId" value="@IssuerValue" @oninput="OnIssuerInput" placeholder="IDENTITY..." />
        <datalist id="@_issuerListId">
            @foreach (var issuer in Registry.GetIssuers())
            {
                var assets = Registry.GetAssetsForIssuer(issuer);
                var label = string.Join(", ", assets.Select(a => a.Name));
                <option value="@issuer">@label</option>
            }
        </datalist>
    </div>
</div>
<div class="mb-2">
    <label class="form-label small">@NameLabel</label>
    <div class="input-group input-group-sm">
        <input class="form-control form-control-sm" list="@_nameListId" maxlength="7"
               value="@NameValue" @oninput="OnNameInput" />
        <datalist id="@_nameListId">
            @foreach (var asset in _filteredAssets)
            {
                <option value="@asset.Name">@(asset.Label ?? asset.Name)</option>
            }
        </datalist>
        @if (_canSave)
        {
            <button class="btn btn-outline-secondary btn-sm" type="button" @onclick="SaveToRegistry" title="Save to asset registry">+</button>
        }
    </div>
</div>

@code {
    [Parameter] public string IssuerValue { get; set; } = "";
    [Parameter] public EventCallback<string> IssuerValueChanged { get; set; }
    [Parameter] public string NameValue { get; set; } = "";
    [Parameter] public EventCallback<string> NameValueChanged { get; set; }
    [Parameter] public string IssuerLabel { get; set; } = "Asset Issuer Identity";
    [Parameter] public string NameLabel { get; set; } = "Asset Name (up to 7 chars)";

    private string _issuerListId = "il-" + Guid.NewGuid().ToString("N")[..8];
    private string _nameListId = "nl-" + Guid.NewGuid().ToString("N")[..8];

    private IEnumerable<AssetRegistryService.AssetEntry> _filteredAssets = [];
    private bool _canSave;

    protected override void OnParametersSet()
    {
        UpdateFiltered();
    }

    private async Task OnIssuerInput(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        await IssuerValueChanged.InvokeAsync(val);
        IssuerValue = val;
        UpdateFiltered();
    }

    private async Task OnNameInput(ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        await NameValueChanged.InvokeAsync(val);
        NameValue = val;
        UpdateCanSave();
    }

    private void UpdateFiltered()
    {
        _filteredAssets = string.IsNullOrWhiteSpace(IssuerValue)
            ? Registry.GetAll()
            : Registry.GetAssetsForIssuer(IssuerValue);
        UpdateCanSave();
    }

    private void UpdateCanSave()
    {
        _canSave = !string.IsNullOrWhiteSpace(IssuerValue)
                   && !string.IsNullOrWhiteSpace(NameValue)
                   && IdentityValidation.Validate(IssuerValue) == null
                   && !Registry.GetAll().Any(a =>
                       a.Issuer.Equals(IssuerValue.Trim(), StringComparison.OrdinalIgnoreCase) &&
                       a.Name.Equals(NameValue.Trim(), StringComparison.OrdinalIgnoreCase));
    }

    private void SaveToRegistry()
    {
        if (Registry.Add(IssuerValue, NameValue))
        {
            UpdateFiltered();
        }
    }
}
