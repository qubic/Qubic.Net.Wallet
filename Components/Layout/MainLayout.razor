@inherits LayoutComponentBase
@implements IDisposable
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TickDriftService TickDrift
@inject TransactionTrackerService TxTracker
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject QubicSettingsService Settings
@inject QubicStaticService StaticData
@inject AssetRegistryService AssetRegistry
@inject VaultService Vault
@inject NavigationManager Nav
@inject LabelService Labels
@inject FileDialogService DialogService
@inject IJSRuntime JS

<div class="d-flex flex-column vh-100">
    <nav class="qb-navbar">
        <a class="qb-logo" href="/">
            <img src="qubic-logo.svg" alt="Qubic" class="logo-dark" />
            <img src="qubic-logo-light.svg" alt="Qubic" class="logo-light" />
            <span>Wallet</span>
        </a>
        <div class="qb-controls">
            @if (Vault.IsUnlocked && Seed.HasSeed)
            {
                @* ── Vault unlocked, seed active ── *@
                <span class="badge-qb-gold">
                    <i class="bi bi-shield-lock-fill me-1"></i>@(Seed.ActiveLabel ?? "Vault")
                </span>
                @if (Vault.Entries.Count > 1)
                {
                    <select class="form-select form-select-sm mono" style="width:auto;max-width:220px"
                            value="@Seed.Identity?.ToString()"
                            @onchange="OnIdentitySwitched">
                        @foreach (var entry in Vault.Entries)
                        {
                            <option value="@entry.Identity">@entry.Label (@entry.Identity[..8]...)</option>
                        }
                    </select>
                }
                else
                {
                    <span class="badge-qb-cyan mono">@Seed.Identity?.ToString()[..12]...</span>
                }
                <button class="btn btn-sm btn-qb-ghost p-0 ms-1" @onclick="CopyIdentity"
                        title="Copy full identity">
                    <i class="bi @(_identityCopied ? "bi-check-lg text-success" : "bi-clipboard")"></i>
                </button>
                <button class="btn btn-sm btn-qb-ghost" @onclick="LockVault"
                        title="Lock vault and clear seed">
                    <i class="bi bi-lock me-1"></i>Lock
                </button>
            }
            else if (Vault.VaultConfigured && !Vault.IsUnlocked && !_showDirectSeedInput)
            {
                @* ── Vault configured, locked ── *@
                <input type="password" class="form-control form-control-sm"
                       style="width:220px" placeholder="Vault password..."
                       @bind="_vaultPassword" @bind:event="oninput"
                       @onkeydown="OnVaultPasswordKeyDown" />
                <button class="btn btn-sm btn-qb-primary" @onclick="UnlockVault"
                        disabled="@(string.IsNullOrEmpty(_vaultPassword))">
                    <i class="bi bi-unlock me-1"></i>Unlock Vault
                </button>
                @if (_vaultError != null)
                {
                    <span class="text-danger small">@_vaultError</span>
                }
                <button class="btn btn-sm btn-qb-ghost" @onclick="() => _showDirectSeedInput = true"
                        title="Enter seed without vault">
                    <i class="bi bi-key me-1"></i>Use seed directly
                </button>
            }
            else if (Seed.HasSeed && !Vault.IsUnlocked)
            {
                @* ── No vault (or bypassed), seed active ── *@
                <span class="badge-qb-gold">Seed active</span>
                <span class="badge-qb-cyan mono">@Seed.Identity?.ToString()[..12]...</span>
                <button class="btn btn-sm btn-qb-ghost p-0 ms-1" @onclick="CopyIdentity"
                        title="Copy full identity">
                    <i class="bi @(_identityCopied ? "bi-check-lg text-success" : "bi-clipboard")"></i>
                </button>
                @if (!Vault.VaultConfigured)
                {
                    <button class="btn btn-sm btn-qb-ghost" @onclick="() => _showSaveToVault = true"
                            title="Save this seed to a vault">
                        <i class="bi bi-shield-plus me-1"></i>Save to Vault
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-qb-ghost" @onclick="() => _showAddToVault = true"
                            title="Add this seed to the existing vault">
                        <i class="bi bi-shield-plus me-1"></i>Add to Vault
                    </button>
                }
                <button class="btn btn-sm btn-qb-ghost" @onclick="ClearSeedAndResetBypass">Clear</button>
            }
            else
            {
                @* ── No seed ── *@
                <input type="password" class="form-control form-control-sm"
                       style="width:280px" placeholder="Enter 55-char seed to enable signing..."
                       @bind="_seedInput" @bind:event="oninput" />
                <button class="btn btn-sm btn-qb-primary" @onclick="SetSeed"
                        disabled="@(_seedInput?.Length != 55)">Unlock</button>
                @if (_showDirectSeedInput && Vault.VaultConfigured)
                {
                    <button class="btn btn-sm btn-qb-ghost" @onclick="() => _showDirectSeedInput = false">
                        Back to vault
                    </button>
                }
            }
            <div class="qb-divider"></div>
            <select class="form-select form-select-sm" style="width:auto"
                    @bind="Backend.ActiveBackend" @bind:after="OnBackendChanged">
                <option value="@QueryBackend.Rpc">RPC</option>
                <option value="@QueryBackend.Bob">Bob</option>
                <option value="@QueryBackend.DirectNetwork">Direct</option>
            </select>
            @if (Backend.ActiveBackend == QueryBackend.DirectNetwork)
            {
                <input class="form-control form-control-sm" style="width:130px"
                       placeholder="Host" @bind="Backend.NodeHost" @bind:event="oninput" />
                <input type="number" class="form-control form-control-sm" style="width:70px"
                       placeholder="Port" @bind="Backend.NodePort" />
            }
            else
            {
                <input class="form-control form-control-sm" style="width:130px"
                       placeholder="Host" @bind="CurrentHost" @bind:event="oninput" />
            }
            @if (TickMonitor.IsConnected)
            {
                <button class="btn btn-sm btn-qb-danger" @onclick="Disconnect">
                    <i class="bi bi-power"></i>
                </button>
                <span class="badge-qb-success mono">E@(TickMonitor.Epoch) | T@(TickMonitor.Tick)</span>
                @if (TickDrift.HasDrift)
                {
                    <span class="badge-qb-warning" title="Tick drift detected: @TickDrift.MaxDrift ticks between backends">
                        <i class="bi bi-exclamation-triangle-fill"></i> Drift @TickDrift.MaxDrift
                    </span>
                }
            }
            else
            {
                <button class="btn btn-sm btn-qb-secondary" @onclick="Reconnect" disabled="@_reconnecting">
                    @(_reconnecting ? "..." : "Connect")
                </button>
                @if (TickMonitor.Error != null)
                {
                    <span class="badge-qb-danger" title="@TickMonitor.Error">Offline</span>
                }
            }
        </div>
    </nav>
    @if (Seed.HasSeed)
    {
        <div class="qb-seed-bar">
            @if (Vault.IsUnlocked)
            {
                <i class="bi bi-shield-lock-fill me-1"></i>
                @:Vault unlocked with @Vault.Entries.Count identity(ies). Lock when done.
            }
            else
            {
                @:Your seed is held in memory for this session. Clear it when done.
            }
        </div>
    }
    <div class="d-flex flex-grow-1 overflow-hidden">
        <NavMenu />
        <main class="flex-grow-1 overflow-auto p-4">
            <ErrorBoundary @ref="_errorBoundary">
                <ChildContent>
                    @Body
                </ChildContent>
                <ErrorContent>
                    <div class="d-flex flex-column align-items-center justify-content-center py-5">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size:3rem"></i>
                        <h5 class="mt-3">Something went wrong</h5>
                        <p class="text-muted">An error occurred while rendering this page.</p>
                        <button class="btn btn-primary" @onclick="RecoverFromError">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reload Page
                        </button>
                    </div>
                </ErrorContent>
            </ErrorBoundary>
        </main>
    </div>
</div>

@* ── Save-to-Vault Modal ── *@
@if (_showSaveToVault && Seed.HasSeed)
{
    <div class="modal d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="bi bi-shield-plus me-2"></i>Save Seed to Vault</h6>
                    <button type="button" class="btn-close" @onclick="CloseSaveToVault"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small">Vault File Location</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control"
                                   placeholder="Path to save vault file..."
                                   @bind="_saveVaultPath" />
                            @if (DialogService.IsAvailable)
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="BrowseSaveVaultPath">
                                    <i class="bi bi-folder2-open"></i>
                                </button>
                            }
                        </div>
                        <div class="form-text">Choose where to save your encrypted vault file.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Label for this seed</label>
                        <input type="text" class="form-control form-control-sm"
                               placeholder="e.g. Main, Trading, Savings"
                               @bind="_saveVaultLabel" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Vault Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_saveVaultPassword" @bind:event="oninput" />
                        @{ var pwHint = VaultService.ValidatePassword(_saveVaultPassword); }
                        @if (!string.IsNullOrEmpty(_saveVaultPassword) && pwHint != null)
                        {
                            <div class="text-warning small mt-1">@pwHint</div>
                        }
                        <div class="form-text">Min 12 chars, uppercase, lowercase, digit, and special character.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Confirm Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_saveVaultPasswordConfirm" @bind:event="oninput" />
                        @if (!string.IsNullOrEmpty(_saveVaultPasswordConfirm) && _saveVaultPassword != _saveVaultPasswordConfirm)
                        {
                            <div class="text-warning small mt-1">Passwords do not match.</div>
                        }
                    </div>
                    @if (_saveVaultError != null)
                    {
                        <div class="alert alert-danger small py-1">@_saveVaultError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="CloseSaveToVault">Cancel</button>
                    <button class="btn btn-sm btn-primary" @onclick="SaveCurrentSeedToVault">
                        <i class="bi bi-shield-plus me-1"></i>Create Vault
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* ── Add-to-Vault Modal (when vault already exists) ── *@
@if (_showAddToVault && Seed.HasSeed && Vault.VaultConfigured)
{
    <div class="modal d-block" tabindex="-1" style="background:rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="bi bi-shield-plus me-2"></i>Add Seed to Vault</h6>
                    <button type="button" class="btn-close" @onclick="CloseAddToVault"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small">Label for this seed</label>
                        <input type="text" class="form-control form-control-sm"
                               placeholder="e.g. Main, Trading, Savings"
                               @bind="_addToVaultLabel" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">Vault Password</label>
                        <input type="password" class="form-control form-control-sm"
                               placeholder="Enter your vault password to unlock and add..."
                               @bind="_addToVaultPassword" @bind:event="oninput" />
                    </div>
                    @if (_addToVaultError != null)
                    {
                        <div class="alert alert-danger small py-1">@_addToVaultError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="CloseAddToVault">Cancel</button>
                    <button class="btn btn-sm btn-primary" @onclick="AddCurrentSeedToVault">
                        <i class="bi bi-shield-plus me-1"></i>Add to Vault
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private ErrorBoundary? _errorBoundary;
    private string? _seedInput;
    private bool _reconnecting;
    private bool _disposed;
    private bool _identityCopied;

    // Vault state
    private string? _vaultPassword;
    private string? _vaultError;
    private bool _showDirectSeedInput;

    // Save-to-vault modal (new vault)
    private bool _showSaveToVault;
    private string _saveVaultPath = "";
    private string _saveVaultLabel = "";
    private string _saveVaultPassword = "";
    private string _saveVaultPasswordConfirm = "";
    private string? _saveVaultError;

    // Add-to-vault modal (existing vault)
    private bool _showAddToVault;
    private string _addToVaultLabel = "";
    private string _addToVaultPassword = "";
    private string? _addToVaultError;

    private string CurrentHost
    {
        get => Backend.ActiveBackend == QueryBackend.Rpc ? Backend.RpcHost : Backend.BobHost;
        set { if (Backend.ActiveBackend == QueryBackend.Rpc) Backend.RpcHost = value; else Backend.BobHost = value; }
    }

    protected override async Task OnInitializedAsync()
    {
        TickMonitor.OnTickChanged += OnTickChanged;
        TickDrift.OnDriftChanged += OnDriftChanged;
        Vault.OnVaultChanged += OnVaultChanged;
        await TickMonitor.StartAsync();
        TickDrift.Start();

        if (Settings.RemoteLabelsEnabled)
            _ = LoadLabelsWithRetry();

        // Auto-refresh asset registry if stale (once per day)
        _ = AssetRegistry.RefreshFromNetworkAsync(Backend);

        // Default vault path for save dialog
        _saveVaultPath = Path.Combine(Settings.StorageDirectory, "vault.dat");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var saved = Settings.GetCustom<string>("theme");
            if (!string.IsNullOrEmpty(saved) && saved != "dark")
                await JS.InvokeVoidAsync("setTheme", saved);
        }
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnDriftChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnVaultChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    // ── Seed (direct entry) ──

    private void SetSeed()
    {
        if (_seedInput?.Length == 55)
        {
            try
            {
                Seed.SetSeed(_seedInput);
                WalletStorage.SetSeed(_seedInput, Seed.Identity!.Value.ToString(), TickMonitor.Epoch);
                TxTracker.SetEncryptionKey(_seedInput);
                _seedInput = null;
            }
            catch { }
        }
    }

    private void ClearSeed()
    {
        Seed.ClearSeed();
        WalletStorage.ClearSeed();
        TxTracker.ClearEncryptionKey();
        _seedInput = null;
        Nav.NavigateTo("/", forceLoad: false);
    }

    private void ClearSeedAndResetBypass()
    {
        _showDirectSeedInput = false;
        ClearSeed();
    }

    // ── Vault ──

    private void UnlockVault()
    {
        if (string.IsNullOrEmpty(_vaultPassword)) return;
        _vaultError = null;

        var unlockError = Vault.UnlockVault(_vaultPassword);
        if (unlockError != null)
        {
            _vaultError = unlockError;
            return;
        }

        _vaultPassword = null;

        // Auto-activate
        var entries = Vault.Entries;
        if (entries.Count == 0) return;

        VaultEntry? toActivate;
        if (entries.Count == 1)
        {
            toActivate = entries[0];
        }
        else
        {
            var lastIdentity = Settings.GetCustom<string>("vault_last_identity");
            toActivate = entries.FirstOrDefault(e => e.Identity == lastIdentity) ?? entries[0];
        }

        ActivateVaultEntry(toActivate);
    }

    private void OnVaultPasswordKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") UnlockVault();
    }

    private void LockVault()
    {
        ClearSeed();
        Vault.LockVault();
    }

    private void OnIdentitySwitched(ChangeEventArgs e)
    {
        var identity = e.Value?.ToString();
        if (identity == null) return;
        var entry = Vault.GetEntry(identity);
        if (entry != null) ActivateVaultEntry(entry);
    }

    private void ActivateVaultEntry(VaultEntry entry)
    {
        try
        {
            Seed.SetSeed(entry.Seed, entry.Label);
            WalletStorage.SetSeed(entry.Seed, entry.Identity, TickMonitor.Epoch);
            TxTracker.SetEncryptionKey(entry.Seed);
            Settings.SetCustom("vault_last_identity", entry.Identity);
            _seedInput = null;
        }
        catch { }
    }

    // ── Save to vault ──

    private void SaveCurrentSeedToVault()
    {
        _saveVaultError = null;

        if (string.IsNullOrWhiteSpace(_saveVaultPath))
        {
            _saveVaultError = "File location is required.";
            return;
        }
        if (string.IsNullOrWhiteSpace(_saveVaultLabel))
        {
            _saveVaultError = "Label is required.";
            return;
        }
        var pwError = VaultService.ValidatePassword(_saveVaultPassword);
        if (pwError != null)
        {
            _saveVaultError = pwError;
            return;
        }
        if (_saveVaultPassword != _saveVaultPasswordConfirm)
        {
            _saveVaultError = "Passwords do not match.";
            return;
        }

        try
        {
            var seed = Seed.GetSeedForVault();
            var entries = new List<VaultEntry>
            {
                new() { Label = _saveVaultLabel, Seed = seed }
            };
            Vault.CreateVault(_saveVaultPath, _saveVaultPassword, entries);

            // Re-activate through vault path
            Seed.SetSeed(seed, _saveVaultLabel);

            CloseSaveToVault();
        }
        catch (Exception ex)
        {
            _saveVaultError = ex.Message;
        }
    }

    private async Task BrowseSaveVaultPath()
    {
        var path = await DialogService.ShowSaveFileAsync("Save Vault File", _saveVaultPath, ".dat",
            ("Vault files", new[] { "*.dat" }), ("All files", new[] { "*.*" }));
        if (path != null) _saveVaultPath = path;
    }

    private void CloseSaveToVault()
    {
        _showSaveToVault = false;
        _saveVaultLabel = "";
        _saveVaultPassword = "";
        _saveVaultPasswordConfirm = "";
        _saveVaultError = null;
    }

    // ── Add to existing vault ──

    private void AddCurrentSeedToVault()
    {
        _addToVaultError = null;

        if (string.IsNullOrWhiteSpace(_addToVaultLabel))
        {
            _addToVaultError = "Label is required.";
            return;
        }
        if (string.IsNullOrEmpty(_addToVaultPassword))
        {
            _addToVaultError = "Password is required.";
            return;
        }

        try
        {
            var seed = Seed.GetSeedForVault();

            // Unlock the vault if needed
            if (!Vault.IsUnlocked)
            {
                var err = Vault.UnlockVault(_addToVaultPassword);
                if (err != null)
                {
                    _addToVaultError = err;
                    return;
                }
            }

            // Add the current seed
            Vault.AddEntry(_addToVaultLabel, seed);

            // Re-activate through vault so we're now in vault mode
            var entry = Vault.GetEntry(Seed.Identity!.Value.ToString());
            if (entry != null)
                ActivateVaultEntry(entry);

            _showDirectSeedInput = false;
            CloseAddToVault();
        }
        catch (Exception ex)
        {
            _addToVaultError = ex.Message;
        }
    }

    private void CloseAddToVault()
    {
        _showAddToVault = false;
        _addToVaultLabel = "";
        _addToVaultPassword = "";
        _addToVaultError = null;
    }

    // ── Identity ──

    private async Task CopyIdentity()
    {
        var id = Seed.Identity?.ToString();
        if (id == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", id);
        _identityCopied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _identityCopied = false;
    }

    // ── Error recovery ──

    private void RecoverFromError()
    {
        _errorBoundary?.Recover();
        Nav.NavigateTo("/", forceLoad: false);
    }

    // ── Backend ──

    private async Task OnBackendChanged()
    {
        Backend.ResetClients();
        await TickMonitor.StartAsync();
    }

    private async Task Reconnect()
    {
        _reconnecting = true;
        StateHasChanged();
        Backend.ResetClients();
        await TickMonitor.StartAsync();
        _reconnecting = false;
    }

    private async Task Disconnect()
    {
        await TickMonitor.StopAsync();
        Backend.ResetClients();
    }

    private async Task LoadLabelsWithRetry()
    {
        await StaticData.LoadAsync();
        if (Labels.RemoteLabelCount == 0 && StaticData.LastError == null)
        {
            await Task.Delay(3000);
            if (!_disposed)
                await StaticData.LoadAsync();
        }
    }

    public void Dispose()
    {
        _disposed = true;
        TickMonitor.OnTickChanged -= OnTickChanged;
        TickDrift.OnDriftChanged -= OnDriftChanged;
        Vault.OnVaultChanged -= OnVaultChanged;
    }
}
