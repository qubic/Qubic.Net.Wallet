@inherits LayoutComponentBase
@implements IDisposable
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject QubicSettingsService Settings
@inject QubicStaticService StaticData
@inject AssetRegistryService AssetRegistry
@inject NavigationManager Nav
@inject LabelService Labels
@inject IJSRuntime JS

<div class="d-flex flex-column vh-100">
    <nav class="qb-navbar">
        <a class="qb-logo" href="/">
            <img src="qubic-logo.svg" alt="Qubic" />
            <span>Wallet</span>
        </a>
        <div class="qb-controls">
            @if (Seed.HasSeed)
            {
                <span class="badge-qb-gold">Seed active</span>
                <span class="badge-qb-cyan mono">@Seed.Identity?.ToString()[..12]...</span>
                <button class="btn btn-sm btn-qb-ghost p-0 ms-1" @onclick="CopyIdentity"
                        title="Copy full identity">
                    <i class="bi @(_identityCopied ? "bi-check-lg text-success" : "bi-clipboard")"></i>
                </button>
                <button class="btn btn-sm btn-qb-ghost" @onclick="ClearSeed">Clear</button>
            }
            else
            {
                <input type="password" class="form-control form-control-sm"
                       style="width:280px" placeholder="Enter 55-char seed to enable signing..."
                       @bind="_seedInput" @bind:event="oninput" />
                <button class="btn btn-sm btn-qb-primary" @onclick="SetSeed"
                        disabled="@(_seedInput?.Length != 55)">Unlock</button>
            }
            <div class="qb-divider"></div>
            <select class="form-select form-select-sm" style="width:auto"
                    @bind="Backend.ActiveBackend" @bind:after="OnBackendChanged">
                <option value="@QueryBackend.Rpc">RPC</option>
                <option value="@QueryBackend.Bob">Bob</option>
                <option value="@QueryBackend.DirectNetwork">Direct</option>
            </select>
            @if (Backend.ActiveBackend == QueryBackend.DirectNetwork)
            {
                <input class="form-control form-control-sm" style="width:130px"
                       placeholder="Host" @bind="Backend.NodeHost" @bind:event="oninput" />
                <input type="number" class="form-control form-control-sm" style="width:70px"
                       placeholder="Port" @bind="Backend.NodePort" />
            }
            else
            {
                <input class="form-control form-control-sm" style="width:130px"
                       placeholder="Host" @bind="CurrentHost" @bind:event="oninput" />
            }
            @if (TickMonitor.IsConnected)
            {
                <button class="btn btn-sm btn-qb-danger" @onclick="Disconnect">
                    <i class="bi bi-power"></i>
                </button>
                <span class="badge-qb-success mono">E@(TickMonitor.Epoch) | T@(TickMonitor.Tick)</span>
            }
            else
            {
                <button class="btn btn-sm btn-qb-secondary" @onclick="Reconnect" disabled="@_reconnecting">
                    @(_reconnecting ? "..." : "Connect")
                </button>
                @if (TickMonitor.Error != null)
                {
                    <span class="badge-qb-danger" title="@TickMonitor.Error">Offline</span>
                }
            }
        </div>
    </nav>
    @if (Seed.HasSeed)
    {
        <div class="qb-seed-bar">
            Your seed is held in memory for this session. Clear it when done.
        </div>
    }
    <div class="d-flex flex-grow-1 overflow-hidden">
        <NavMenu />
        <main class="flex-grow-1 overflow-auto p-4">
            @Body
        </main>
    </div>
</div>

@code {
    private string? _seedInput;
    private bool _reconnecting;
    private bool _disposed;
    private bool _identityCopied;

    private string CurrentHost
    {
        get => Backend.ActiveBackend == QueryBackend.Rpc ? Backend.RpcHost : Backend.BobHost;
        set { if (Backend.ActiveBackend == QueryBackend.Rpc) Backend.RpcHost = value; else Backend.BobHost = value; }
    }

    protected override async Task OnInitializedAsync()
    {
        TickMonitor.OnTickChanged += OnTickChanged;
        await TickMonitor.StartAsync();

        if (Settings.RemoteLabelsEnabled)
            _ = LoadLabelsWithRetry();

        // Auto-refresh asset registry if stale (once per day)
        _ = AssetRegistry.RefreshFromNetworkAsync(Backend);
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void SetSeed()
    {
        if (_seedInput?.Length == 55)
        {
            try
            {
                Seed.SetSeed(_seedInput);
                WalletStorage.SetSeed(_seedInput, Seed.Identity!.Value.ToString());
                TxTracker.SetEncryptionKey(_seedInput);
                _seedInput = null;
            }
            catch { }
        }
    }

    private async Task CopyIdentity()
    {
        var id = Seed.Identity?.ToString();
        if (id == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", id);
        _identityCopied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _identityCopied = false;
    }

    private void ClearSeed()
    {
        Seed.ClearSeed();
        WalletStorage.ClearSeed();
        TxTracker.ClearEncryptionKey();
        _seedInput = null;
        Nav.NavigateTo("/", forceLoad: false);
    }

    private async Task OnBackendChanged()
    {
        Backend.ResetClients();
        await TickMonitor.StartAsync();
    }

    private async Task Reconnect()
    {
        _reconnecting = true;
        StateHasChanged();
        Backend.ResetClients();
        await TickMonitor.StartAsync();
        _reconnecting = false;
    }

    private async Task Disconnect()
    {
        await TickMonitor.StopAsync();
        Backend.ResetClients();
    }

    private async Task LoadLabelsWithRetry()
    {
        await StaticData.LoadAsync();
        if (Labels.RemoteLabelCount == 0 && StaticData.LastError == null)
        {
            await Task.Delay(3000);
            if (!_disposed)
                await StaticData.LoadAsync();
        }
    }

    public void Dispose()
    {
        _disposed = true;
        TickMonitor.OnTickChanged -= OnTickChanged;
    }
}
