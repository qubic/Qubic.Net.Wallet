@page "/history"
@implements IDisposable
@inject TransactionTrackerService TxTracker
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject TickMonitorService TickMonitor
@inject SeedSessionService Seed
@inject IJSRuntime JS

<h4>Transaction History</h4>
<p class="text-muted">Track broadcast transactions and view synced history. Data is encrypted locally per seed.</p>

@* ── Sync Status ── *@
@if (WalletStorage.IsOpen)
{
    <div class="mb-3">
        <div class="d-flex align-items-center gap-2 small">
            @if (WalletStorage.Sync.State == Qubic.Services.Storage.SyncState.Syncing)
            {
                <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                <span>Syncing...</span>
            }
            else
            {
                <i class="bi bi-check-circle text-success"></i>
                <span>Synced: @WalletStorage.TransactionCount tx, @WalletStorage.LogEventCount logs</span>
            }
            <button class="btn btn-link btn-sm p-0 ms-1" @onclick="() => _showSyncDetails = !_showSyncDetails">
                <i class="bi @(_showSyncDetails ? "bi-chevron-up" : "bi-chevron-down")"></i>
            </button>
        </div>
        @if (_showSyncDetails)
        {
            <div class="mt-1 ms-3 small">
                @{ var sync = WalletStorage.Sync; }
                <div class="d-flex align-items-center gap-2 mb-1">
                    @if (IsStreamSpinner(sync.RpcStatus))
                    { <span class="spinner-border spinner-border-sm text-primary" style="width:.7em;height:.7em"></span> }
                    else
                    { <i class="@StreamIconClass(sync.RpcStatus)"></i> }
                    <strong>RPC Transactions:</strong>
                    <span class="text-muted">@(sync.RpcStatusMessage ?? "Idle")</span>
                </div>
                <div class="d-flex align-items-center gap-2 mb-1">
                    @if (IsStreamSpinner(sync.BobLogStatus))
                    { <span class="spinner-border spinner-border-sm text-primary" style="width:.7em;height:.7em"></span> }
                    else
                    { <i class="@StreamIconClass(sync.BobLogStatus)"></i> }
                    <strong>Bob Logs:</strong>
                    <span class="text-muted">@(sync.BobLogStatusMessage ?? "Idle")</span>
                </div>
                @if (sync.LastError != null)
                {
                    <div class="text-danger mt-1"><i class="bi bi-exclamation-triangle me-1"></i>@sync.LastError</div>
                }
            </div>
        }
    </div>
}

@* ── Tabs ── *@
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(_activeTab == Tab.Tracked ? "active" : "")" @onclick="() => _activeTab = Tab.Tracked">
            Tracked (@TxTracker.Transactions.Count)
        </button>
    </li>
    @if (WalletStorage.IsOpen)
    {
        <li class="nav-item">
            <button class="nav-link @(_activeTab == Tab.All ? "active" : "")" @onclick="LoadAllTransactions">
                All Transactions (@WalletStorage.TransactionCount)
            </button>
        </li>
    }
</ul>

@if (_activeTab == Tab.Tracked)
{
    @* ── Tracked Transactions Tab ── *@
    @if (TxTracker.CurrentStoragePath != null && !WalletStorage.IsOpen)
    {
        <div class="small text-muted mb-2">
            Storage: <code>@TxTracker.CurrentStoragePath</code>
        </div>
    }

    <div class="d-flex gap-2 mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick="ExportToFile" disabled="@(TxTracker.Transactions.Count == 0)">
            Export JSON
        </button>
        <button class="btn btn-sm btn-outline-secondary" @onclick="() => _showImport = !_showImport">
            @(_showImport ? "Hide Import" : "Import JSON")
        </button>
        @if (TxTracker.Transactions.Count > 0)
        {
            <button class="btn btn-sm btn-outline-danger ms-auto" @onclick="ClearAll">Clear All</button>
        }
    </div>

    @if (_exportMessage != null)
    {
        <div class="alert alert-success alert-dismissible py-1 small">
            @_exportMessage
            <button type="button" class="btn-close btn-close-sm" @onclick="() => _exportMessage = null"></button>
        </div>
    }

    @if (_showImport)
    {
        <div class="card mb-3 bg-body-secondary">
            <div class="card-body py-2">
                <label class="form-label-sm">Paste exported JSON or load from file:</label>
                <div class="d-flex gap-2 mb-2">
                    <input type="file" id="importFileInput" accept=".json" style="display:none" />
                    <button class="btn btn-sm btn-outline-primary" @onclick="LoadFromFile">Load File</button>
                </div>
                <textarea class="form-control form-control-sm mono" rows="6"
                          placeholder="Paste JSON here..." @bind="_importText"></textarea>
                <div class="mt-2 d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-primary" @onclick="ImportFromText">Import</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => { _showImport = false; _importText = null; _importError = null; }">Cancel</button>
                    @if (_importError != null)
                    {
                        <span class="text-danger small">@_importError</span>
                    }
                    @if (_importSuccess != null)
                    {
                        <span class="text-success small">@_importSuccess</span>
                    }
                </div>
            </div>
        </div>
    }

    @if (TxTracker.Transactions.Count == 0)
    {
        <div class="alert alert-info">No transactions tracked yet. Transactions will appear here after you broadcast them.</div>
    }
    else
    {
        <div class="mb-2 small text-muted">@TxTracker.Transactions.Count transaction(s)</div>

        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Tx ID</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Target Tick</th>
                        <th>Created</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in TxTracker.Transactions)
                    {
                        <tr>
                            <td>
                                @switch (tx.Status)
                                {
                                    case TrackedTxStatus.Pending:
                                        if (TickMonitor.IsConnected && tx.TargetTick > TickMonitor.Tick)
                                        {
                                            <span class="badge bg-warning text-dark" title="Waiting for tick @tx.TargetTick (current: @TickMonitor.Tick)">
                                                Pending (@(tx.TargetTick - TickMonitor.Tick) ticks)
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                        break;
                                    case TrackedTxStatus.Confirmed:
                                        <span class="badge bg-success">Confirmed</span>
                                        break;
                                    case TrackedTxStatus.Failed:
                                        <span class="badge bg-danger">Failed</span>
                                        break;
                                    case TrackedTxStatus.Unknown:
                                        <span class="badge bg-secondary">Unknown</span>
                                        break;
                                }
                            </td>
                            <td class="mono small" style="max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                                title="@tx.Hash">
                                <a href="https://explorer.qubic.org/network/tx/@tx.Hash" target="_blank" rel="noopener">@tx.Hash</a>
                            </td>
                            <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                                title="@tx.Description">@tx.Description</td>
                            <td class="mono">@tx.Amount.ToString("N0")</td>
                            <td class="mono">@tx.TargetTick.ToString("N0")</td>
                            <td class="small">@tx.CreatedUtc.ToLocalTime().ToString("HH:mm:ss")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleDetails(tx.Hash)">
                                    @(_expandedHash == tx.Hash ? "Hide" : "Details")
                                </button>
                                <button class="btn btn-sm btn-outline-danger ms-1" @onclick="() => TxTracker.Remove(tx.Hash)">x</button>
                            </td>
                        </tr>
                        @if (_expandedHash == tx.Hash)
                        {
                            <tr>
                                <td colspan="7">
                                    <div class="bg-body-secondary rounded p-3">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr>
                                                <td class="text-muted" style="width:120px">Tx ID</td>
                                                <td class="mono">
                                                    @tx.Hash
                                                    <a href="https://explorer.qubic.org/network/tx/@tx.Hash" target="_blank" rel="noopener" class="ms-2 small">Explorer</a>
                                                </td>
                                            </tr>
                                            <tr><td class="text-muted">Source</td><td><AddressDisplay Address="@tx.Source" /></td></tr>
                                            <tr><td class="text-muted">Destination</td><td><AddressDisplay Address="@tx.Destination" /></td></tr>
                                            <tr><td class="text-muted">Amount</td><td>@tx.Amount.ToString("N0") QU</td></tr>
                                            <tr><td class="text-muted">Target Tick</td><td>@tx.TargetTick.ToString("N0")</td></tr>
                                            <tr><td class="text-muted">Description</td><td>@tx.Description</td></tr>
                                            <tr><td class="text-muted">Status</td><td>@tx.Status</td></tr>
                                            @if (tx.MoneyFlew != null)
                                            {
                                                <tr><td class="text-muted">Money Flew</td><td>@tx.MoneyFlew</td></tr>
                                            }
                                            <tr><td class="text-muted">Created</td><td>@tx.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td></tr>
                                            @if (tx.ResolvedUtc != null)
                                            {
                                                <tr><td class="text-muted">Resolved</td><td>@tx.ResolvedUtc.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td></tr>
                                            }
                                            @if (!string.IsNullOrEmpty(tx.RawData))
                                            {
                                                <tr>
                                                    <td class="text-muted">Raw Data</td>
                                                    <td><textarea class="form-control form-control-sm mono" rows="3" readonly style="font-size:0.75em">@tx.RawData</textarea></td>
                                                </tr>
                                            }
                                        </table>
                                        @if (Seed.HasSeed)
                                        {
                                            <div class="mt-2">
                                                <button class="btn btn-sm btn-outline-primary" disabled="@(_repeating == tx.Hash)"
                                                        @onclick="() => RepeatTransaction(tx)">
                                                    @(_repeating == tx.Hash ? "Repeating..." : "Repeat Transaction")
                                                </button>
                                                @if (_repeatResult == tx.Hash)
                                                {
                                                    <span class="text-success small ms-2">New tx broadcast! <a href="https://explorer.qubic.org/network/tx/@_repeatNewHash" target="_blank" rel="noopener">@_repeatNewHash?[..20]...</a></span>
                                                }
                                                @if (_repeatError != null && _repeating != tx.Hash && _repeatErrorHash == tx.Hash)
                                                {
                                                    <span class="text-danger small ms-2">@_repeatError</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
}
else
{
    @* ── All Transactions Tab ── *@
    <div class="d-flex gap-2 mb-3 align-items-center flex-wrap">
        <select class="form-select form-select-sm" style="width:auto" @bind="_allDirection" @bind:after="LoadAllTransactions">
            <option value="@Qubic.Services.Storage.TransactionDirection.All">All</option>
            <option value="@Qubic.Services.Storage.TransactionDirection.Sent">Sent</option>
            <option value="@Qubic.Services.Storage.TransactionDirection.Received">Received</option>
        </select>
        <select class="form-select form-select-sm" style="width:auto" @bind="_allHashType" @bind:after="LoadAllTransactions">
            <option value="@Qubic.Services.Storage.TxHashType.All">All Types</option>
            <option value="@Qubic.Services.Storage.TxHashType.User">User</option>
            <option value="@Qubic.Services.Storage.TxHashType.System">System</option>
        </select>
        <input type="number" class="form-control form-control-sm" style="width:120px" placeholder="Min tick"
               @bind="_allMinTick" @bind:event="oninput" />
        <input type="number" class="form-control form-control-sm" style="width:120px" placeholder="Max tick"
               @bind="_allMaxTick" @bind:event="oninput" />
        <button class="btn btn-sm btn-primary" @onclick="LoadAllTransactions">Filter</button>
    </div>

    @if (_allTransactions == null || _allTransactions.Count == 0)
    {
        <div class="alert alert-info">No synced transactions yet. Sync will populate this view as transactions are fetched.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Tick</th>
                        <th>Tx Hash</th>
                        <th>Source</th>
                        <th>Destination</th>
                        <th>Amount</th>
                        <th>Sources</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tx in _allTransactions)
                    {
                        <tr>
                            <td class="small text-nowrap">@FormatTimestamp(tx.TimestampMs)</td>
                            <td class="mono">@tx.Tick.ToString("N0")</td>
                            <td class="mono small" style="max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                                title="@tx.Hash">
                                <a href="https://explorer.qubic.org/network/tx/@tx.Hash" target="_blank" rel="noopener">@tx.Hash</a>
                            </td>
                            <td><AddressDisplay Address="@tx.Source" TruncateChars="6" /></td>
                            <td><AddressDisplay Address="@tx.Destination" TruncateChars="6" /></td>
                            <td class="mono">@long.Parse(tx.Amount).ToString("N0")</td>
                            <td>
                                @foreach (var src in tx.SyncedFrom.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                {
                                    <span class="badge bg-info text-dark me-1">@src</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleAllDetails(tx.Hash)">
                                    @(_allExpandedHash == tx.Hash ? "Hide" : "Details")
                                </button>
                            </td>
                        </tr>
                        @if (_allExpandedHash == tx.Hash)
                        {
                            <tr>
                                <td colspan="8">
                                    <div class="bg-body-secondary rounded p-3">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr><td class="text-muted" style="width:120px">Tx Hash</td><td class="mono">@tx.Hash</td></tr>
                                            <tr><td class="text-muted">Source</td><td><AddressDisplay Address="@tx.Source" ShowFull="true" /></td></tr>
                                            <tr><td class="text-muted">Destination</td><td><AddressDisplay Address="@tx.Destination" ShowFull="true" /></td></tr>
                                            <tr><td class="text-muted">Amount</td><td>@long.Parse(tx.Amount).ToString("N0") QU</td></tr>
                                            <tr><td class="text-muted">Tick</td><td>@tx.Tick.ToString("N0")</td></tr>
                                            @if (tx.TimestampMs.HasValue)
                                            {
                                                <tr><td class="text-muted">Timestamp</td><td>@DateTimeOffset.FromUnixTimeMilliseconds(tx.TimestampMs.Value).UtcDateTime.ToString("yyyy-MM-dd HH:mm:ss") UTC</td></tr>
                                            }
                                            <tr><td class="text-muted">Input Type</td><td>@tx.InputType</td></tr>
                                            @if (tx.InputSize > 0 && !string.IsNullOrEmpty(tx.InputData))
                                            {
                                                <tr><td class="text-muted">Input Size</td><td>@tx.InputSize</td></tr>
                                            }
                                            @if (tx.MoneyFlew.HasValue)
                                            {
                                                <tr><td class="text-muted">Money Flew</td><td>@tx.MoneyFlew</td></tr>
                                            }
                                            @if (tx.Success.HasValue)
                                            {
                                                <tr><td class="text-muted">Success</td><td>@tx.Success</td></tr>
                                            }
                                            <tr><td class="text-muted">Synced From</td><td>@tx.SyncedFrom</td></tr>
                                            <tr><td class="text-muted">Synced At</td><td>@tx.SyncedAtUtc</td></tr>
                                            @{ var rawHex = ReconstructRawHex(tx); }
                                            @if (rawHex != null)
                                            {
                                                <tr>
                                                    <td class="text-muted">Raw Data</td>
                                                    <td><textarea class="form-control form-control-sm mono" rows="3" readonly style="font-size:0.75em">@rawHex</textarea></td>
                                                </tr>
                                            }
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-secondary" disabled="@(_allOffset == 0)" @onclick="PrevPage">Prev</button>
            <span class="small text-muted">Page @(_allOffset / _allPageSize + 1)</span>
            <button class="btn btn-sm btn-outline-secondary" disabled="@(_allTransactions.Count < _allPageSize)" @onclick="NextPage">Next</button>
        </div>
    }
}

@code {
    private enum Tab { Tracked, All }
    private Tab _activeTab = Tab.Tracked;
    private bool _showSyncDetails;

    // Tracked tab state
    private string? _expandedHash;
    private bool _showImport;
    private string? _importText;
    private string? _importError;
    private string? _importSuccess;
    private string? _exportMessage;
    private string? _repeating;
    private string? _repeatResult;
    private string? _repeatNewHash;
    private string? _repeatError;
    private string? _repeatErrorHash;

    // All transactions tab state
    private List<Qubic.Services.Storage.StoredTransaction>? _allTransactions;
    private Qubic.Services.Storage.TransactionDirection _allDirection = Qubic.Services.Storage.TransactionDirection.All;
    private Qubic.Services.Storage.TxHashType _allHashType = Qubic.Services.Storage.TxHashType.All;
    private uint? _allMinTick;
    private uint? _allMaxTick;
    private int _allOffset;
    private const int _allPageSize = 50;
    private string? _allExpandedHash;

    private bool _disposed;

    protected override void OnInitialized()
    {
        TxTracker.OnChanged += OnTrackerChanged;
        TickMonitor.OnTickChanged += OnTickChanged;
        WalletStorage.Sync.OnSyncStateChanged += OnSyncChanged;
    }

    private void OnTrackerChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnSyncChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void ToggleDetails(string hash) => _expandedHash = _expandedHash == hash ? null : hash;
    private void ToggleAllDetails(string hash) => _allExpandedHash = _allExpandedHash == hash ? null : hash;

    private void LoadAllTransactions()
    {
        _activeTab = Tab.All;
        _allTransactions = WalletStorage.GetTransactions(new Qubic.Services.Storage.TransactionQuery
        {
            Direction = _allDirection,
            HashType = _allHashType,
            MinTick = _allMinTick,
            MaxTick = _allMaxTick,
            Offset = _allOffset,
            Limit = _allPageSize
        });
    }

    private void PrevPage()
    {
        _allOffset = Math.Max(0, _allOffset - _allPageSize);
        LoadAllTransactions();
    }

    private void NextPage()
    {
        _allOffset += _allPageSize;
        LoadAllTransactions();
    }

    private async Task ExportToFile()
    {
        try
        {
            var json = TxTracker.ExportJson();
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var base64 = Convert.ToBase64String(bytes);
            var filename = $"qubic-tx-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            await JS.InvokeVoidAsync("downloadFile", filename, "application/json", base64);
            _exportMessage = $"Exported {TxTracker.Transactions.Count} transaction(s) to {filename}";
        }
        catch (Exception ex)
        {
            _exportMessage = "Export failed: " + ex.Message;
        }
    }

    private async Task LoadFromFile()
    {
        _importError = null;
        _importSuccess = null;
        try
        {
            var content = await JS.InvokeAsync<string?>("readFileAsText", "importFileInput");
            if (content != null)
            {
                _importText = content;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _importError = "Could not read file: " + ex.Message;
        }
    }

    private void ImportFromText()
    {
        _importError = null;
        _importSuccess = null;

        if (string.IsNullOrWhiteSpace(_importText))
        {
            _importError = "Nothing to import.";
            return;
        }

        try
        {
            var count = TxTracker.ImportJson(_importText.Trim());
            if (count == 0)
                _importSuccess = "No new transactions to import (all duplicates).";
            else
                _importSuccess = $"Imported {count} transaction(s).";
            _importText = null;
        }
        catch (Exception ex)
        {
            _importError = "Invalid JSON: " + ex.Message;
        }
    }

    private async Task RepeatTransaction(TrackedTransaction tx)
    {
        _repeating = tx.Hash;
        _repeatResult = null;
        _repeatNewHash = null;
        _repeatError = null;
        _repeatErrorHash = null;

        try
        {
            var newHash = await TxTracker.RepeatAsync(tx);
            _repeatResult = tx.Hash;
            _repeatNewHash = newHash;
        }
        catch (Exception ex)
        {
            _repeatError = ex.Message;
            _repeatErrorHash = tx.Hash;
        }
        finally
        {
            _repeating = null;
        }
    }

    private void ClearAll()
    {
        TxTracker.Clear();
        _expandedHash = null;
    }

    private static string StreamIconClass(Qubic.Services.Storage.StreamStatus status) => status switch
    {
        Qubic.Services.Storage.StreamStatus.Connecting => "spinner",
        Qubic.Services.Storage.StreamStatus.CatchingUp => "spinner",
        Qubic.Services.Storage.StreamStatus.Live => "bi bi-check-circle-fill text-success",
        Qubic.Services.Storage.StreamStatus.Error => "bi bi-exclamation-triangle-fill text-danger",
        _ => "bi bi-circle text-muted",
    };

    private static bool IsStreamSpinner(Qubic.Services.Storage.StreamStatus status) =>
        status is Qubic.Services.Storage.StreamStatus.Connecting or Qubic.Services.Storage.StreamStatus.CatchingUp;

    private static string FormatTimestamp(long? timestampMs)
    {
        if (!timestampMs.HasValue) return "—";
        var dt = DateTimeOffset.FromUnixTimeMilliseconds(timestampMs.Value).UtcDateTime;
        return dt.ToString("yyyy-MM-dd HH:mm");
    }

    private static string? ReconstructRawHex(Qubic.Services.Storage.StoredTransaction tx)
    {
        try
        {
            if (string.IsNullOrEmpty(tx.Signature) || tx.Signature.Length != 128) return null;
            var srcId = Qubic.Core.Entities.QubicIdentity.FromIdentity(tx.Source);
            var dstId = Qubic.Core.Entities.QubicIdentity.FromIdentity(tx.Destination);
            var inputData = !string.IsNullOrEmpty(tx.InputData) ? Convert.FromHexString(tx.InputData) : [];
            var sig = Convert.FromHexString(tx.Signature);
            var totalSize = 32 + 32 + 8 + 4 + 2 + 2 + inputData.Length + 64;
            var bytes = new byte[totalSize];
            var offset = 0;
            Array.Copy(srcId.PublicKey, 0, bytes, offset, 32); offset += 32;
            Array.Copy(dstId.PublicKey, 0, bytes, offset, 32); offset += 32;
            System.Buffers.Binary.BinaryPrimitives.WriteInt64LittleEndian(bytes.AsSpan(offset), long.Parse(tx.Amount)); offset += 8;
            System.Buffers.Binary.BinaryPrimitives.WriteUInt32LittleEndian(bytes.AsSpan(offset), tx.Tick); offset += 4;
            System.Buffers.Binary.BinaryPrimitives.WriteUInt16LittleEndian(bytes.AsSpan(offset), (ushort)tx.InputType); offset += 2;
            System.Buffers.Binary.BinaryPrimitives.WriteUInt16LittleEndian(bytes.AsSpan(offset), (ushort)tx.InputSize); offset += 2;
            if (inputData.Length > 0) { Array.Copy(inputData, 0, bytes, offset, inputData.Length); offset += inputData.Length; }
            Array.Copy(sig, 0, bytes, offset, 64);
            return Convert.ToHexString(bytes);
        }
        catch { return null; }
    }

    public void Dispose()
    {
        _disposed = true;
        TxTracker.OnChanged -= OnTrackerChanged;
        TickMonitor.OnTickChanged -= OnTickChanged;
        WalletStorage.Sync.OnSyncStateChanged -= OnSyncChanged;
    }
}
