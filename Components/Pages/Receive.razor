@page "/receive"
@inject SeedSessionService Seed
@inject IJSRuntime JS

<h4>Receive QU</h4>

@if (!Seed.HasSeed)
{
    <div class="alert alert-warning">Enter your seed in the top bar to view your address.</div>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">Your Identity</div>
                <div class="card-body text-center py-4">
                    <p class="text-muted small mb-3">Share this address to receive QU or assets.</p>
                    @if (_qrSvg != null)
                    {
                        <div class="mb-3 d-flex justify-content-center">
                            <div id="qr-container" style="width:250px; height:250px; background:white; padding:12px; border-radius:8px">
                                @((MarkupString)_qrSvg)
                            </div>
                        </div>
                    }
                    <div class="p-3 bg-body-tertiary rounded mb-3">
                        <code class="mono d-block fs-5" style="word-break:break-all; letter-spacing:0.1em">@Seed.Identity</code>
                    </div>
                    <button class="btn btn-primary" @onclick="CopyAddress">
                        <i class="bi @(_copied ? "bi-check-lg" : "bi-clipboard") me-1"></i>
                        @(_copied ? "Copied!" : "Copy Address")
                    </button>
                    @if (_qrSvg != null)
                    {
                        <button class="btn btn-outline-primary ms-2" @onclick="CopyQr">
                            <i class="bi @(_qrCopied ? "bi-check-lg" : "bi-image") me-1"></i>
                            @(_qrCopied ? "Copied!" : "Copy QR")
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _copied;
    private bool _qrCopied;
    private string? _qrSvg;

    protected override void OnParametersSet()
    {
        if (Seed.Identity != null)
        {
            var gen = new QRCoder.QRCodeGenerator();
            var data = gen.CreateQrCode(Seed.Identity.Value.ToString(), QRCoder.QRCodeGenerator.ECCLevel.M);
            var svg = new QRCoder.SvgQRCode(data);
            _qrSvg = svg.GetGraphic(5);
        }
    }

    private async Task CopyAddress()
    {
        if (Seed.Identity == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", Seed.Identity.ToString());
        _copied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _copied = false;
    }

    private async Task CopyQr()
    {
        if (_qrSvg == null) return;
        try
        {
            await JS.InvokeVoidAsync("copyQrAsImage", "qr-container");
            _qrCopied = true;
            StateHasChanged();
            await Task.Delay(2000);
            _qrCopied = false;
        }
        catch { }
    }
}
