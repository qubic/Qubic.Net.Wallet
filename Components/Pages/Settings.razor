@page "/settings"
@inject QubicSettingsService Cfg
@inject QubicBackendService Backend
@inject LabelService Labels
@inject QubicStaticService StaticData
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject SeedSessionService Seed
@inject IJSRuntime JS

<h4>Settings</h4>
<p class="text-muted">Configure Qubic.Net Wallet behavior.</p>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "general" ? "active" : "")" href="" @onclick="@(() => SetTab("general"))" @onclick:preventDefault>
            <i class="bi bi-gear me-1"></i>General
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "connection" ? "active" : "")" href="" @onclick="@(() => SetTab("connection"))" @onclick:preventDefault>
            <i class="bi bi-plug me-1"></i>Connection
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "transactions" ? "active" : "")" href="" @onclick="@(() => SetTab("transactions"))" @onclick:preventDefault>
            <i class="bi bi-arrow-left-right me-1"></i>Transactions
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "labels" ? "active" : "")" href="" @onclick="@(() => SetTab("labels"))" @onclick:preventDefault>
            <i class="bi bi-tags me-1"></i>Labels
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "data" ? "active" : "")" href="" @onclick="@(() => SetTab("data"))" @onclick:preventDefault>
            <i class="bi bi-database me-1"></i>Data
        </a>
    </li>
</ul>

@if (_activeTab == "general")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <label class="form-label">Theme</label>
            <select class="form-select" value="@_theme" @onchange="OnThemeChanged">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
    </div></div>
}
else if (_activeTab == "connection")
{
    <div class="row"><div class="col-md-8">
        <div class="mb-3">
            <label class="form-label">Default Backend</label>
            <select class="form-select" value="@Backend.ActiveBackend" @onchange="OnBackendChanged">
                <option value="@QueryBackend.Rpc">RPC</option>
                <option value="@QueryBackend.Bob">Bob (JSON-RPC)</option>
                <option value="@QueryBackend.DirectNetwork">Direct Network</option>
            </select>
            <div class="form-text">
                RPC supports most features. Bob provides transfer history.
                Direct Network connects to a node directly.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">RPC Connection</label>
            <div class="input-group">
                <select class="form-select" style="max-width:100px"
                        value="@Backend.RpcScheme" @onchange="OnRpcSchemeChanged">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.RpcHost" @onchange="OnRpcHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.RpcPort" @onchange="OnRpcPortChanged" />
            </div>
            <div class="form-text">Current URL: <code>@Backend.RpcUrl</code></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Bob Connection</label>
            <div class="input-group">
                <select class="form-select" style="max-width:100px"
                        value="@Backend.BobScheme" @onchange="OnBobSchemeChanged">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.BobHost" @onchange="OnBobHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.BobPort" @onchange="OnBobPortChanged" />
            </div>
            <div class="form-text">Current URL: <code>@Backend.BobUrl</code></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Node Connection</label>
            <div class="input-group">
                <span class="input-group-text" style="min-width:100px;justify-content:center">TCP</span>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.NodeHost" @onchange="OnNodeHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.NodePort" @onchange="OnNodePortChanged" />
            </div>
            <div class="form-text">Current: <code>tcp://@(Backend.NodeHost):@(Backend.NodePort)</code></div>
        </div>
    </div></div>
}
else if (_activeTab == "transactions")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <label class="form-label">Auto-Tick Offset</label>
            <input type="number" class="form-control" min="1" max="100"
                   value="@Cfg.TickOffset"
                   @onchange="e => Cfg.TickOffset = int.TryParse(e.Value?.ToString(), out var v) ? v : 5" />
            <div class="form-text">
                Number of ticks added to the current tick when using auto-tick.
            </div>
        </div>

        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoResend"
                       checked="@Cfg.AutoResend"
                       @onchange="e => Cfg.AutoResend = (bool)(e.Value ?? false)" />
                <label class="form-check-label" for="autoResend">
                    Auto-Resend Failed Transactions
                </label>
            </div>
            <div class="form-text">
                Automatically re-sign and rebroadcast transactions whose target tick has passed.
            </div>
        </div>

        @if (Cfg.AutoResend)
        {
            <div class="mb-3">
                <label class="form-label">Max Resend Attempts</label>
                <input type="number" class="form-control" min="1" max="20"
                       value="@Cfg.AutoResendMaxRetries"
                       @onchange="e => Cfg.AutoResendMaxRetries = int.TryParse(e.Value?.ToString(), out var v) ? v : 3" />
            </div>
        }
    </div></div>
}
else if (_activeTab == "labels")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="remoteLabels"
                       checked="@Cfg.RemoteLabelsEnabled"
                       @onchange="OnRemoteLabelsToggled" />
                <label class="form-check-label" for="remoteLabels">
                    Load labels from remote registry
                </label>
            </div>
            <div class="form-text">
                Fetches known address labels from <code>static.qubic.org</code> on startup.
            </div>
        </div>

        @if (Cfg.RemoteLabelsEnabled)
        {
            <div class="d-flex align-items-center gap-2 mb-2">
                <button class="btn btn-outline-primary btn-sm" @onclick="RefreshLabels" disabled="@StaticData.IsLoading">
                    <i class="bi bi-arrow-clockwise me-1"></i>@(StaticData.IsLoading ? "Loading..." : "Refresh Labels")
                </button>
                @if (StaticData.LastFetched != null)
                {
                    <span class="text-muted small">
                        @Labels.RemoteLabelCount labels at @StaticData.LastFetched.Value.ToString("HH:mm:ss")
                    </span>
                }
            </div>

            @if (StaticData.LastError != null)
            {
                <div class="alert alert-danger small py-1 mb-0">@StaticData.LastError</div>
            }
        }
    </div></div>
}
else if (_activeTab == "data")
{
    <div class="row"><div class="col-md-8">
        <div class="alert alert-warning py-2 mb-3">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Your database is <strong>encrypted with your seed</strong>. Without the seed, the database file is useless.
            Always keep a secure backup of your seed alongside any database export.
        </div>

        @if (!WalletStorage.IsOpen)
        {
            <div class="text-muted">Enter your seed to access database import/export.</div>
        }
        else
        {
            <div class="card mb-3">
                <div class="card-header">Export Database</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        Download a backup of your wallet database. This includes all synced transactions,
                        log events, and tracked transactions.
                    </p>
                    <button class="btn btn-primary btn-sm" @onclick="ExportDatabase" disabled="@_exporting">
                        @if (_exporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-download me-1"></i>Export Database
                    </button>
                    @if (_exportError != null)
                    {
                        <div class="text-danger small mt-2">@_exportError</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Import Database</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        Restore a previously exported database. This will <strong>replace</strong> your current database
                        with the imported file. The imported file must have been created with the same seed.
                    </p>
                    <div class="mb-2">
                        <InputFile OnChange="OnImportFileSelected" accept=".walletdb" class="form-control form-control-sm" />
                    </div>
                    @if (_importFile != null)
                    {
                        <div class="d-flex align-items-center gap-2">
                            <span class="small text-muted">@_importFile.Name (@FormatSize(_importFile.Size))</span>
                            <button class="btn btn-outline-danger btn-sm" @onclick="ImportDatabase"
                                    disabled="@_importing">
                                @if (_importing)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-upload me-1"></i>Replace Current Database
                            </button>
                        </div>
                    }
                    @if (_importSuccess)
                    {
                        <div class="text-success small mt-2"><i class="bi bi-check-circle me-1"></i>Database imported successfully.</div>
                    }
                    @if (_importError != null)
                    {
                        <div class="text-danger small mt-2">@_importError</div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header">Storage Info</div>
                <div class="card-body small">
                    <div class="mb-1"><strong>Database path:</strong> <code>@WalletStorage.Database.DatabasePath</code></div>
                    <div class="mb-1"><strong>Transactions:</strong> @WalletStorage.TransactionCount</div>
                    <div><strong>Log events:</strong> @WalletStorage.LogEventCount</div>
                </div>
            </div>
        }
    </div></div>
}

@code {
    private string _theme = "light";
    private string _activeTab = "general";

    private void SetTab(string tab) => _activeTab = tab;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var saved = Cfg.GetCustom<string>("theme");
            if (!string.IsNullOrEmpty(saved))
                _theme = saved;
            else
            {
                try { _theme = await JS.InvokeAsync<string>("getTheme") ?? "light"; }
                catch { _theme = "light"; }
            }
            StateHasChanged();
        }
    }

    private async Task OnThemeChanged(ChangeEventArgs e)
    {
        _theme = e.Value?.ToString() ?? "light";
        Cfg.SetCustom("theme", _theme);
        await JS.InvokeVoidAsync("setTheme", _theme);
    }

    private void OnBackendChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<QueryBackend>(e.Value?.ToString(), out var b))
        {
            Backend.ActiveBackend = b;
            Backend.ApplySettings();
        }
    }

    private void OnRpcSchemeChanged(ChangeEventArgs e) { Backend.RpcScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnRpcHostChanged(ChangeEventArgs e) { Backend.RpcHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnRpcPortChanged(ChangeEventArgs e) { Backend.RpcPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnBobSchemeChanged(ChangeEventArgs e) { Backend.BobScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnBobHostChanged(ChangeEventArgs e) { Backend.BobHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnBobPortChanged(ChangeEventArgs e) { Backend.BobPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnNodeHostChanged(ChangeEventArgs e) { Backend.NodeHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnNodePortChanged(ChangeEventArgs e) { Backend.NodePort = int.TryParse(e.Value?.ToString(), out var v) ? v : 21841; Backend.ApplySettings(); }

    private async Task OnRemoteLabelsToggled(ChangeEventArgs e)
    {
        Cfg.RemoteLabelsEnabled = (bool)(e.Value ?? false);
        if (Cfg.RemoteLabelsEnabled)
            await RefreshLabels();
        else
            StaticData.Clear();
    }

    private async Task RefreshLabels()
    {
        await StaticData.LoadAsync();
        StateHasChanged();
    }

    // ── Data import/export ──
    private bool _exporting;
    private string? _exportError;
    private IBrowserFile? _importFile;
    private bool _importing;
    private bool _importSuccess;
    private string? _importError;

    private async Task ExportDatabase()
    {
        _exporting = true;
        _exportError = null;
        StateHasChanged();
        try
        {
            var data = WalletStorage.ExportDatabase();
            var base64 = Convert.ToBase64String(data);
            var identity = Seed.Identity?.ToString() ?? "wallet";
            var filename = $"qubic-wallet-{identity[..8]}-{DateTime.UtcNow:yyyyMMdd}.walletdb";
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var byteChars = atob('{base64}');
                    var bytes = new Uint8Array(byteChars.length);
                    for (var i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
                    var blob = new Blob([bytes], {{ type: 'application/octet-stream' }});
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = '{filename}';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                }})();
            ");
        }
        catch (Exception ex) { _exportError = ex.Message; }
        finally { _exporting = false; }
    }

    private void OnImportFileSelected(InputFileChangeEventArgs e)
    {
        _importFile = e.File;
        _importSuccess = false;
        _importError = null;
    }

    private async Task ImportDatabase()
    {
        if (_importFile == null) return;
        _importing = true;
        _importSuccess = false;
        _importError = null;
        StateHasChanged();
        try
        {
            const long maxSize = 100 * 1024 * 1024; // 100 MB
            using var stream = _importFile.OpenReadStream(maxSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var data = ms.ToArray();

            WalletStorage.ImportDatabase(data);
            _importFile = null;
            _importSuccess = true;
        }
        catch (Exception ex) { _importError = ex.Message; }
        finally { _importing = false; }
    }

    private static string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }
}
