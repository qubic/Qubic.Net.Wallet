@page "/settings"
@inject QubicSettingsService Cfg
@inject QubicBackendService Backend
@inject LabelService Labels
@inject QubicStaticService StaticData
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject SeedSessionService Seed
@inject IJSRuntime JS
@inject VaultService Vault
@inject TransactionTrackerService TxTracker

<h4>Settings</h4>
<p class="text-muted">Configure Qubic.Net Wallet behavior.</p>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "general" ? "active" : "")" href="" @onclick="@(() => SetTab("general"))" @onclick:preventDefault>
            <i class="bi bi-gear me-1"></i>General
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "connection" ? "active" : "")" href="" @onclick="@(() => SetTab("connection"))" @onclick:preventDefault>
            <i class="bi bi-plug me-1"></i>Connection
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "transactions" ? "active" : "")" href="" @onclick="@(() => SetTab("transactions"))" @onclick:preventDefault>
            <i class="bi bi-arrow-left-right me-1"></i>Transactions
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "labels" ? "active" : "")" href="" @onclick="@(() => SetTab("labels"))" @onclick:preventDefault>
            <i class="bi bi-tags me-1"></i>Labels
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "data" ? "active" : "")" href="" @onclick="@(() => SetTab("data"))" @onclick:preventDefault>
            <i class="bi bi-database me-1"></i>Data
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(_activeTab == "vault" ? "active" : "")" href="" @onclick="@(() => SetTab("vault"))" @onclick:preventDefault>
            <i class="bi bi-shield-lock me-1"></i>Vault
        </a>
    </li>
</ul>

@if (_activeTab == "general")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <label class="form-label">Theme</label>
            <select class="form-select" value="@_theme" @onchange="OnThemeChanged">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
            </select>
        </div>
    </div></div>
}
else if (_activeTab == "connection")
{
    <div class="row"><div class="col-md-8">
        <div class="mb-3">
            <label class="form-label">Default Backend</label>
            <select class="form-select" value="@Backend.ActiveBackend" @onchange="OnBackendChanged">
                <option value="@QueryBackend.Rpc">RPC</option>
                <option value="@QueryBackend.Bob">Bob (JSON-RPC)</option>
                <option value="@QueryBackend.DirectNetwork">Direct Network</option>
            </select>
            <div class="form-text">
                RPC supports most features. Bob provides transfer history.
                Direct Network connects to a node directly.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">RPC Connection</label>
            <div class="input-group">
                <select class="form-select" style="max-width:100px"
                        value="@Backend.RpcScheme" @onchange="OnRpcSchemeChanged">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.RpcHost" @onchange="OnRpcHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.RpcPort" @onchange="OnRpcPortChanged" />
            </div>
            <div class="form-text">Current URL: <code>@Backend.RpcUrl</code></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Bob Connection</label>
            <div class="input-group">
                <select class="form-select" style="max-width:100px"
                        value="@Backend.BobScheme" @onchange="OnBobSchemeChanged">
                    <option value="https">https</option>
                    <option value="http">http</option>
                </select>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.BobHost" @onchange="OnBobHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.BobPort" @onchange="OnBobPortChanged" />
            </div>
            <div class="form-text">Current URL: <code>@Backend.BobUrl</code></div>
        </div>

        <div class="mb-3">
            <label class="form-label">Node Connection</label>
            <div class="input-group">
                <span class="input-group-text" style="min-width:100px;justify-content:center">TCP</span>
                <input type="text" class="form-control" placeholder="Host"
                       value="@Backend.NodeHost" @onchange="OnNodeHostChanged" />
                <input type="number" class="form-control" style="max-width:100px"
                       placeholder="Port" min="1" max="65535"
                       value="@Backend.NodePort" @onchange="OnNodePortChanged" />
            </div>
            <div class="form-text">Current: <code>tcp://@(Backend.NodeHost):@(Backend.NodePort)</code></div>
        </div>
    </div></div>
}
else if (_activeTab == "transactions")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <label class="form-label">Auto-Tick Offset</label>
            <input type="number" class="form-control" min="1" max="100"
                   value="@Cfg.TickOffset"
                   @onchange="e => Cfg.TickOffset = int.TryParse(e.Value?.ToString(), out var v) ? v : 5" />
            <div class="form-text">
                Number of ticks added to the current tick when using auto-tick.
            </div>
        </div>

        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoResend"
                       checked="@Cfg.AutoResend"
                       @onchange="e => Cfg.AutoResend = (bool)(e.Value ?? false)" />
                <label class="form-check-label" for="autoResend">
                    Auto-Resend Failed Transactions
                </label>
            </div>
            <div class="form-text">
                Automatically re-sign and rebroadcast transactions whose target tick has passed.
            </div>
        </div>

        @if (Cfg.AutoResend)
        {
            <div class="mb-3">
                <label class="form-label">Max Resend Attempts</label>
                <input type="number" class="form-control" min="1" max="20"
                       value="@Cfg.AutoResendMaxRetries"
                       @onchange="e => Cfg.AutoResendMaxRetries = int.TryParse(e.Value?.ToString(), out var v) ? v : 3" />
            </div>
        }
    </div></div>
}
else if (_activeTab == "labels")
{
    <div class="row"><div class="col-md-6">
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="remoteLabels"
                       checked="@Cfg.RemoteLabelsEnabled"
                       @onchange="OnRemoteLabelsToggled" />
                <label class="form-check-label" for="remoteLabels">
                    Load labels from remote registry
                </label>
            </div>
            <div class="form-text">
                Fetches known address labels from <code>static.qubic.org</code> on startup.
            </div>
        </div>

        @if (Cfg.RemoteLabelsEnabled)
        {
            <div class="d-flex align-items-center gap-2 mb-2">
                <button class="btn btn-outline-primary btn-sm" @onclick="RefreshLabels" disabled="@StaticData.IsLoading">
                    <i class="bi bi-arrow-clockwise me-1"></i>@(StaticData.IsLoading ? "Loading..." : "Refresh Labels")
                </button>
                @if (StaticData.LastFetched != null)
                {
                    <span class="text-muted small">
                        @Labels.RemoteLabelCount labels at @StaticData.LastFetched.Value.ToString("HH:mm:ss")
                    </span>
                }
            </div>

            @if (StaticData.LastError != null)
            {
                <div class="alert alert-danger small py-1 mb-0">@StaticData.LastError</div>
            }
        }
    </div></div>
}
else if (_activeTab == "data")
{
    <div class="row"><div class="col-md-8">
        <div class="alert alert-warning py-2 mb-3">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Your database is <strong>encrypted with your seed</strong>. Without the seed, the database file is useless.
            Always keep a secure backup of your seed alongside any database export.
        </div>

        @if (!WalletStorage.IsOpen)
        {
            <div class="text-muted">Enter your seed to access database import/export.</div>
        }
        else
        {
            <div class="card mb-3">
                <div class="card-header">Export Database</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        Download a backup of your wallet database. This includes all synced transactions,
                        log events, and tracked transactions.
                    </p>
                    <button class="btn btn-primary btn-sm" @onclick="ExportDatabase" disabled="@_exporting">
                        @if (_exporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-download me-1"></i>Export Database
                    </button>
                    @if (_exportError != null)
                    {
                        <div class="text-danger small mt-2">@_exportError</div>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Import Database</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        Restore a previously exported database. This will <strong>replace</strong> your current database
                        with the imported file. The imported file must have been created with the same seed.
                    </p>
                    <div class="mb-2">
                        <InputFile OnChange="OnImportFileSelected" accept=".walletdb" class="form-control form-control-sm" />
                    </div>
                    @if (_importFile != null)
                    {
                        <div class="d-flex align-items-center gap-2">
                            <span class="small text-muted">@_importFile.Name (@FormatSize(_importFile.Size))</span>
                            <button class="btn btn-outline-danger btn-sm" @onclick="ImportDatabase"
                                    disabled="@_importing">
                                @if (_importing)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-upload me-1"></i>Replace Current Database
                            </button>
                        </div>
                    }
                    @if (_importSuccess)
                    {
                        <div class="text-success small mt-2"><i class="bi bi-check-circle me-1"></i>Database imported successfully.</div>
                    }
                    @if (_importError != null)
                    {
                        <div class="text-danger small mt-2">@_importError</div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header">Storage Info</div>
                <div class="card-body small">
                    <div class="mb-1"><strong>Database path:</strong> <code>@WalletStorage.Database.DatabasePath</code></div>
                    <div class="mb-1"><strong>Transactions:</strong> @WalletStorage.TransactionCount</div>
                    <div><strong>Log events:</strong> @WalletStorage.LogEventCount</div>
                </div>
            </div>
        }
    </div></div>
}
else if (_activeTab == "vault")
{
    <div class="row"><div class="col-md-8">
        @if (!Vault.VaultConfigured)
        {
            <div class="alert alert-info py-2 mb-3">
                <i class="bi bi-info-circle me-1"></i>
                No vault configured. Create a new vault or open an existing vault file.
            </div>
            <div class="card mb-3">
                <div class="card-header">Create New Vault</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Vault File Location</label>
                        <input type="text" class="form-control form-control-sm"
                               @bind="_vaultCreatePath" placeholder="Path to save vault file..." />
                        <div class="form-text">Choose where to save your encrypted vault file.</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Seed (55 characters)</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultCreateSeed" placeholder="Enter 55-char seed..." />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Label</label>
                        <input type="text" class="form-control form-control-sm"
                               @bind="_vaultCreateLabel" placeholder="e.g. Main" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultCreatePassword" @bind:event="oninput" />
                        @{ var cpwHint = VaultService.ValidatePassword(_vaultCreatePassword); }
                        @if (!string.IsNullOrEmpty(_vaultCreatePassword) && cpwHint != null)
                        {
                            <div class="text-warning small mt-1">@cpwHint</div>
                        }
                        <div class="form-text">Min 12 chars, uppercase, lowercase, digit, and special character.</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Confirm Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultCreatePasswordConfirm" />
                    </div>
                    @if (_vaultCreateError != null)
                    {
                        <div class="text-danger small mb-2">@_vaultCreateError</div>
                    }
                    <button class="btn btn-primary btn-sm" @onclick="CreateVaultFromSettings">
                        <i class="bi bi-shield-plus me-1"></i>Create Vault
                    </button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">Open Existing Vault</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Vault File Path</label>
                        <input type="text" class="form-control form-control-sm"
                               @bind="_vaultOpenPath" placeholder="Path to existing vault file..." />
                    </div>
                    @if (_vaultOpenError != null)
                    {
                        <div class="text-danger small mb-2">@_vaultOpenError</div>
                    }
                    <button class="btn btn-outline-primary btn-sm" @onclick="OpenExistingVault">
                        <i class="bi bi-folder2-open me-1"></i>Open Vault
                    </button>
                </div>
            </div>
        }
        else if (Vault.IsUnlocked)
        {
            <div class="alert alert-success py-2 mb-3">
                <i class="bi bi-unlock me-1"></i>
                Vault is unlocked. File: <code>@Vault.VaultPath</code>
            </div>

            <div class="card mb-3">
                <div class="card-header">Vault Entries</div>
                <div class="card-body">
                    @if (Vault.Entries.Count == 0)
                    {
                        <p class="text-muted small mb-0">No entries in vault.</p>
                    }
                    else
                    {
                        <table class="table table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>Identity</th>
                                    <th style="width:150px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in Vault.Entries)
                                {
                                    <tr>
                                        <td>
                                            @if (_renamingIdentity == entry.Identity)
                                            {
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control form-control-sm"
                                                           @bind="_renameLabel" />
                                                    <button class="btn btn-outline-success btn-sm" @onclick="() => ConfirmRename(entry.Identity)">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" @onclick="CancelRename">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            }
                                            else
                                            {
                                                @entry.Label
                                            }
                                        </td>
                                        <td><code class="small">@entry.Identity</code></td>
                                        <td>
                                            @if (_renamingIdentity != entry.Identity)
                                            {
                                                <button class="btn btn-outline-secondary btn-sm me-1" @onclick="() => StartRename(entry)"
                                                        title="Rename">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveVaultEntry(entry)"
                                                        title="Remove">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Add Seed to Vault</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Seed (55 characters)</label>
                        <div class="input-group input-group-sm">
                            <input type="@(_vaultAddSeedRevealed ? "text" : "password")" class="form-control form-control-sm mono"
                                   @bind="_vaultAddSeed" placeholder="Enter or generate a 55-char seed..." />
                            <button class="btn btn-outline-secondary" type="button"
                                    @onclick="() => _vaultAddSeedRevealed = !_vaultAddSeedRevealed"
                                    title="@(_vaultAddSeedRevealed ? "Hide" : "Reveal")">
                                <i class="bi @(_vaultAddSeedRevealed ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                            <button class="btn btn-outline-primary" type="button" @onclick="GenerateVaultAddSeed"
                                    title="Generate random seed">
                                <i class="bi bi-shuffle me-1"></i>Generate
                            </button>
                        </div>
                    </div>
                    @if (_vaultAddSeedGenerated)
                    {
                        <div class="alert alert-danger small py-2 mb-2">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <strong>Write down this seed and store it safely!</strong> If you lose it, there is no recovery.
                        </div>
                    }
                    <div class="mb-2">
                        <label class="form-label small">Label</label>
                        <input type="text" class="form-control form-control-sm"
                               @bind="_vaultAddLabel" placeholder="e.g. Trading" />
                    </div>
                    @if (_vaultAddError != null)
                    {
                        <div class="text-danger small mb-2">@_vaultAddError</div>
                    }
                    <button class="btn btn-primary btn-sm" @onclick="AddVaultEntry">
                        <i class="bi bi-plus-circle me-1"></i>Add Entry
                    </button>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><i class="bi bi-person-lines-fill me-1"></i>Address Book</div>
                <div class="card-body">
                    @if (Vault.Contacts.Count == 0)
                    {
                        <p class="text-muted small mb-0">No contacts in address book.</p>
                    }
                    else
                    {
                        <table class="table table-sm table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>Address</th>
                                    <th style="width:150px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var contact in Vault.Contacts)
                                {
                                    <tr>
                                        <td>
                                            @if (_renamingContactAddr == contact.Address)
                                            {
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control form-control-sm"
                                                           @bind="_contactRenameLabel" />
                                                    <button class="btn btn-outline-success btn-sm" @onclick="() => ConfirmContactRename(contact.Address)">
                                                        <i class="bi bi-check"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary btn-sm" @onclick="CancelContactRename">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            }
                                            else
                                            {
                                                @contact.Label
                                            }
                                        </td>
                                        <td><code class="small">@contact.Address[..12]...@contact.Address[^8..]</code></td>
                                        <td>
                                            @if (_renamingContactAddr != contact.Address)
                                            {
                                                <button class="btn btn-outline-secondary btn-sm me-1"
                                                        @onclick="() => StartContactRename(contact)" title="Rename">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm"
                                                        @onclick="() => RemoveContact(contact)" title="Remove">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Add Contact</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Label</label>
                        <input type="text" class="form-control form-control-sm"
                               @bind="_contactAddLabel" placeholder="e.g. Exchange Hot Wallet" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Address (60-character identity)</label>
                        <input class="form-control form-control-sm mono @IdentityValidation.CssClass(_contactAddAddress)"
                               @bind="_contactAddAddress" @bind:event="oninput" placeholder="IDENTITY..." />
                    </div>
                    @if (_contactAddError != null)
                    {
                        <div class="text-danger small mb-2">@_contactAddError</div>
                    }
                    <button class="btn btn-primary btn-sm" @onclick="AddContact">
                        <i class="bi bi-plus-circle me-1"></i>Add Contact
                    </button>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Change Vault Password</div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small">Current Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultOldPassword" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">New Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultNewPassword" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Confirm New Password</label>
                        <input type="password" class="form-control form-control-sm"
                               @bind="_vaultNewPasswordConfirm" />
                    </div>
                    @if (_vaultPasswordChangeError != null)
                    {
                        <div class="text-danger small mb-2">@_vaultPasswordChangeError</div>
                    }
                    @if (_vaultPasswordChanged)
                    {
                        <div class="text-success small mb-2"><i class="bi bi-check-circle me-1"></i>Password changed successfully.</div>
                    }
                    <button class="btn btn-outline-primary btn-sm" @onclick="ChangeVaultPassword">
                        <i class="bi bi-key me-1"></i>Change Password
                    </button>
                </div>
            </div>

            <div class="card border-danger">
                <div class="card-header text-danger">Danger Zone</div>
                <div class="card-body">
                    <p class="small text-muted mb-2">
                        Permanently delete the vault file and all stored entries. This cannot be undone.
                    </p>
                    @if (!_confirmDeleteVault)
                    {
                        <button class="btn btn-outline-danger btn-sm" @onclick="() => _confirmDeleteVault = true">
                            <i class="bi bi-trash me-1"></i>Delete Vault
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-danger py-2 mb-2">
                            <strong>Are you sure?</strong> This will permanently delete your vault and all stored seeds.
                        </div>
                        <button class="btn btn-danger btn-sm me-2" @onclick="DeleteVault">
                            <i class="bi bi-exclamation-triangle me-1"></i>Yes, Delete Vault
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="() => _confirmDeleteVault = false">
                            Cancel
                        </button>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-warning py-2 mb-3">
                <i class="bi bi-lock me-1"></i>
                Vault is locked. Unlock it from the toolbar to manage entries.
            </div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="DisconnectVault">
                <i class="bi bi-box-arrow-right me-1"></i>Disconnect Vault
            </button>
        }
    </div></div>
}

@code {
    private string _theme = "light";
    private string _activeTab = "general";

    private void SetTab(string tab) => _activeTab = tab;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var saved = Cfg.GetCustom<string>("theme");
            if (!string.IsNullOrEmpty(saved))
                _theme = saved;
            else
            {
                try { _theme = await JS.InvokeAsync<string>("getTheme") ?? "light"; }
                catch { _theme = "light"; }
            }
            StateHasChanged();
        }
    }

    private async Task OnThemeChanged(ChangeEventArgs e)
    {
        _theme = e.Value?.ToString() ?? "light";
        Cfg.SetCustom("theme", _theme);
        await JS.InvokeVoidAsync("setTheme", _theme);
    }

    private void OnBackendChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<QueryBackend>(e.Value?.ToString(), out var b))
        {
            Backend.ActiveBackend = b;
            Backend.ApplySettings();
        }
    }

    private void OnRpcSchemeChanged(ChangeEventArgs e) { Backend.RpcScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnRpcHostChanged(ChangeEventArgs e) { Backend.RpcHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnRpcPortChanged(ChangeEventArgs e) { Backend.RpcPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnBobSchemeChanged(ChangeEventArgs e) { Backend.BobScheme = e.Value?.ToString() ?? "https"; Backend.ApplySettings(); }
    private void OnBobHostChanged(ChangeEventArgs e) { Backend.BobHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnBobPortChanged(ChangeEventArgs e) { Backend.BobPort = int.TryParse(e.Value?.ToString(), out var v) ? v : 443; Backend.ApplySettings(); }
    private void OnNodeHostChanged(ChangeEventArgs e) { Backend.NodeHost = e.Value?.ToString() ?? ""; Backend.ApplySettings(); }
    private void OnNodePortChanged(ChangeEventArgs e) { Backend.NodePort = int.TryParse(e.Value?.ToString(), out var v) ? v : 21841; Backend.ApplySettings(); }

    private async Task OnRemoteLabelsToggled(ChangeEventArgs e)
    {
        Cfg.RemoteLabelsEnabled = (bool)(e.Value ?? false);
        if (Cfg.RemoteLabelsEnabled)
            await RefreshLabels();
        else
            StaticData.Clear();
    }

    private async Task RefreshLabels()
    {
        await StaticData.LoadAsync();
        StateHasChanged();
    }

    // ── Data import/export ──
    private bool _exporting;
    private string? _exportError;
    private IBrowserFile? _importFile;
    private bool _importing;
    private bool _importSuccess;
    private string? _importError;

    private async Task ExportDatabase()
    {
        _exporting = true;
        _exportError = null;
        StateHasChanged();
        try
        {
            var data = WalletStorage.ExportDatabase();
            var base64 = Convert.ToBase64String(data);
            var identity = Seed.Identity?.ToString() ?? "wallet";
            var filename = $"qubic-wallet-{identity[..8]}-{DateTime.UtcNow:yyyyMMdd}.walletdb";
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var byteChars = atob('{base64}');
                    var bytes = new Uint8Array(byteChars.length);
                    for (var i = 0; i < byteChars.length; i++) bytes[i] = byteChars.charCodeAt(i);
                    var blob = new Blob([bytes], {{ type: 'application/octet-stream' }});
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = '{filename}';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                }})();
            ");
        }
        catch (Exception ex) { _exportError = ex.Message; }
        finally { _exporting = false; }
    }

    private void OnImportFileSelected(InputFileChangeEventArgs e)
    {
        _importFile = e.File;
        _importSuccess = false;
        _importError = null;
    }

    private async Task ImportDatabase()
    {
        if (_importFile == null) return;
        _importing = true;
        _importSuccess = false;
        _importError = null;
        StateHasChanged();
        try
        {
            const long maxSize = 100 * 1024 * 1024; // 100 MB
            using var stream = _importFile.OpenReadStream(maxSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var data = ms.ToArray();

            WalletStorage.ImportDatabase(data);
            _importFile = null;
            _importSuccess = true;
        }
        catch (Exception ex) { _importError = ex.Message; }
        finally { _importing = false; }
    }

    private static string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F1} MB";
    }

    // ── Vault settings ──
    private string _vaultCreatePath = "";
    private string? _vaultCreateSeed;
    private string? _vaultCreateLabel;
    private string? _vaultCreatePassword;
    private string? _vaultCreatePasswordConfirm;
    private string? _vaultCreateError;

    private string? _vaultOpenPath;
    private string? _vaultOpenError;

    private string? _vaultAddSeed;
    private string? _vaultAddLabel;
    private string? _vaultAddError;
    private bool _vaultAddSeedRevealed;
    private bool _vaultAddSeedGenerated;

    private string? _renamingIdentity;
    private string _renameLabel = "";

    private string? _vaultOldPassword;
    private string? _vaultNewPassword;
    private string? _vaultNewPasswordConfirm;
    private string? _vaultPasswordChangeError;
    private bool _vaultPasswordChanged;

    private bool _confirmDeleteVault;

    // Address book
    private string? _contactAddLabel;
    private string? _contactAddAddress;
    private string? _contactAddError;
    private string? _renamingContactAddr;
    private string _contactRenameLabel = "";

    protected override void OnInitialized()
    {
        _vaultCreatePath = Path.Combine(Cfg.StorageDirectory, "vault.dat");
    }

    private void CreateVaultFromSettings()
    {
        _vaultCreateError = null;
        if (string.IsNullOrWhiteSpace(_vaultCreatePath)) { _vaultCreateError = "File path is required."; return; }
        if (_vaultCreateSeed?.Length != 55) { _vaultCreateError = "Seed must be 55 characters."; return; }
        if (string.IsNullOrWhiteSpace(_vaultCreateLabel)) { _vaultCreateError = "Label is required."; return; }
        var pwError = VaultService.ValidatePassword(_vaultCreatePassword);
        if (pwError != null) { _vaultCreateError = pwError; return; }
        if (_vaultCreatePassword != _vaultCreatePasswordConfirm) { _vaultCreateError = "Passwords do not match."; return; }

        try
        {
            var entries = new List<VaultEntry> { new() { Label = _vaultCreateLabel, Seed = _vaultCreateSeed } };
            Vault.CreateVault(_vaultCreatePath, _vaultCreatePassword!, entries);
            _vaultCreateSeed = null; _vaultCreateLabel = null;
            _vaultCreatePassword = null; _vaultCreatePasswordConfirm = null;
        }
        catch (Exception ex) { _vaultCreateError = ex.Message; }
    }

    private void OpenExistingVault()
    {
        _vaultOpenError = null;
        if (string.IsNullOrWhiteSpace(_vaultOpenPath)) { _vaultOpenError = "File path is required."; return; }
        try
        {
            Vault.SetVaultPath(_vaultOpenPath);
        }
        catch (Exception ex) { _vaultOpenError = ex.Message; }
    }

    private void GenerateVaultAddSeed()
    {
        var bytes = System.Security.Cryptography.RandomNumberGenerator.GetBytes(55);
        var chars = new char[55];
        for (var i = 0; i < 55; i++)
            chars[i] = (char)('a' + bytes[i] % 26);
        _vaultAddSeed = new string(chars);
        _vaultAddSeedGenerated = true;
        _vaultAddError = null;
    }

    private void AddVaultEntry()
    {
        _vaultAddError = null;
        if (string.IsNullOrWhiteSpace(_vaultAddSeed) || _vaultAddSeed.Length != 55)
        {
            _vaultAddError = "Seed must be exactly 55 characters.";
            return;
        }
        if (string.IsNullOrWhiteSpace(_vaultAddLabel))
        {
            _vaultAddError = "Label is required.";
            return;
        }
        try
        {
            Vault.AddEntry(_vaultAddLabel, _vaultAddSeed);
            _vaultAddSeed = null; _vaultAddLabel = null;
            _vaultAddSeedRevealed = false; _vaultAddSeedGenerated = false;
        }
        catch (Exception ex) { _vaultAddError = ex.Message; }
    }

    private void RemoveVaultEntry(VaultEntry entry)
    {
        if (Seed.HasSeed && Seed.Identity?.ToString() == entry.Identity)
        {
            Seed.ClearSeed();
            WalletStorage.ClearSeed();
            TxTracker.ClearEncryptionKey();
        }
        Vault.RemoveEntry(entry.Identity);
    }

    private void StartRename(VaultEntry entry)
    {
        _renamingIdentity = entry.Identity;
        _renameLabel = entry.Label;
    }

    private void ConfirmRename(string identity)
    {
        if (!string.IsNullOrWhiteSpace(_renameLabel))
            Vault.RenameEntry(identity, _renameLabel);
        _renamingIdentity = null;
    }

    private void CancelRename() => _renamingIdentity = null;

    private void ChangeVaultPassword()
    {
        _vaultPasswordChangeError = null;
        _vaultPasswordChanged = false;
        var pwError = VaultService.ValidatePassword(_vaultNewPassword);
        if (pwError != null) { _vaultPasswordChangeError = pwError; return; }
        if (_vaultNewPassword != _vaultNewPasswordConfirm) { _vaultPasswordChangeError = "Passwords do not match."; return; }
        try
        {
            Vault.ChangePassword(_vaultOldPassword!, _vaultNewPassword!);
            _vaultOldPassword = null; _vaultNewPassword = null; _vaultNewPasswordConfirm = null;
            _vaultPasswordChanged = true;
        }
        catch (Exception ex) { _vaultPasswordChangeError = ex.Message; }
    }

    private void DeleteVault()
    {
        Seed.ClearSeed();
        WalletStorage.ClearSeed();
        TxTracker.ClearEncryptionKey();
        Vault.DeleteVault();
        _confirmDeleteVault = false;
    }

    private void DisconnectVault()
    {
        Seed.ClearSeed();
        WalletStorage.ClearSeed();
        TxTracker.ClearEncryptionKey();
        Vault.LockVault();
        Cfg.RemoveCustom("vault_path");
    }

    // ── Address book ──

    private void AddContact()
    {
        _contactAddError = null;
        if (string.IsNullOrWhiteSpace(_contactAddLabel))
        { _contactAddError = "Label is required."; return; }
        var err = IdentityValidation.Validate(_contactAddAddress);
        if (err != null) { _contactAddError = err; return; }
        try
        {
            Vault.AddContact(_contactAddLabel, _contactAddAddress!.Trim());
            _contactAddLabel = null; _contactAddAddress = null;
        }
        catch (Exception ex) { _contactAddError = ex.Message; }
    }

    private void RemoveContact(ContactEntry contact)
    {
        Vault.RemoveContact(contact.Address);
    }

    private void StartContactRename(ContactEntry contact)
    {
        _renamingContactAddr = contact.Address;
        _contactRenameLabel = contact.Label;
    }

    private void ConfirmContactRename(string address)
    {
        if (!string.IsNullOrWhiteSpace(_contactRenameLabel))
            Vault.RenameContact(address, _contactRenameLabel);
        _renamingContactAddr = null;
    }

    private void CancelContactRename() => _renamingContactAddr = null;
}
