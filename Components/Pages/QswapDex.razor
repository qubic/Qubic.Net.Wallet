@page "/qswap"
@inject QubicBackendService Backend
@inject SeedSessionService Seed
@inject TickMonitorService TickMonitor
@inject TransactionTrackerService TxTracker
@inject QubicSettingsService Settings
@inject VaultService Vault

<h4>QSwap AMM</h4>
<p class="text-muted">Issue/transfer assets, create pools, add/remove liquidity, and swap on the QSwap AMM.</p>
<div class="alert alert-info small py-2">This feature is in preview and may change in future updates.</div>

@if (!Seed.HasSeed)
{
    <div class="alert alert-warning">Enter your seed in the top bar to enable signing.</div>
}
else
{
    <ul class="nav nav-tabs mb-3">
        @foreach (var tab in _tabs)
        {
            <li class="nav-item">
                <a class="nav-link @(tab == _activeTab ? "active" : "")" href="" @onclick="() => _activeTab = tab" @onclick:preventDefault>@tab</a>
            </li>
        }
    </ul>

    <div class="row"><div class="col-md-8">
        @switch (_activeTab)
        {
            case "Issue":
                <div class="card"><div class="card-header">Issue Asset (QSwap)</div><div class="card-body">
                    <div class="mb-2"><label class="form-label-sm">Asset Name (max 7 chars)</label>
                        <input class="form-control form-control-sm" maxlength="7" @bind="_issueName" /></div>
                    <div class="mb-2"><label class="form-label-sm">Number of Shares</label>
                        <input type="number" class="form-control form-control-sm" @bind="_issueShares" /></div>
                    <div class="mb-2"><label class="form-label-sm">Unit of Measurement (max 7 chars)</label>
                        <input class="form-control form-control-sm" maxlength="7" @bind="_issueUnit" /></div>
                    <div class="mb-2"><label class="form-label-sm">Decimal Places (0-18)</label>
                        <input type="number" class="form-control form-control-sm" min="0" max="18" @bind="_issueDecimals" /></div>
                    <button class="btn btn-primary" @onclick="IssueAsset" disabled="@_sending">@(_sending ? "Issuing..." : "Issue Asset")</button>
                    @if (_fees != null) { <div class="form-text">Fee: @_fees.Value.issuance.ToString("N0") QU</div> }
                </div></div>
                break;

            case "Transfer":
                <div class="card"><div class="card-header">Transfer Asset (QSwap)</div><div class="card-body">
                    <AssetSelector @bind-IssuerValue="_xferIssuer" @bind-NameValue="_xferName" />
                    <div class="mb-2"><label class="form-label-sm">New Owner Identity</label>
                        <AddressInput @bind-Value="_xferNewOwner" /></div>
                    <div class="mb-2"><label class="form-label-sm">Amount of Shares</label>
                        <input type="number" class="form-control form-control-sm" @bind="_xferAmount" /></div>
                    <button class="btn btn-primary" @onclick="TransferAsset" disabled="@_sending">@(_sending ? "Transferring..." : "Transfer")</button>
                    @if (_fees != null) { <div class="form-text">Fee: @_fees.Value.transfer.ToString("N0") QU</div> }
                </div></div>
                break;

            case "Pool":
                <div class="card"><div class="card-header">Create Pool</div><div class="card-body">
                    <AssetSelector @bind-IssuerValue="_poolIssuer" @bind-NameValue="_poolName" />
                    <button class="btn btn-primary" @onclick="CreatePool" disabled="@_sending">@(_sending ? "Creating..." : "Create Pool")</button>
                    @if (_fees != null) { <div class="form-text">Fee: @_fees.Value.pool.ToString("N0") QU</div> }
                </div></div>
                break;

            case "Liquidity":
                <div class="card"><div class="card-header">Add / Remove Liquidity</div><div class="card-body">
                    <div class="mb-2 d-flex gap-2">
                        <button class="btn btn-sm @(_liqAdd ? "btn-primary" : "btn-outline-primary")" @onclick="() => _liqAdd = true">Add</button>
                        <button class="btn btn-sm @(!_liqAdd ? "btn-primary" : "btn-outline-primary")" @onclick="() => _liqAdd = false">Remove</button>
                    </div>
                    <AssetSelector @bind-IssuerValue="_liqIssuer" @bind-NameValue="_liqName" />
                    @if (_liqAdd)
                    {
                        <div class="mb-2"><label class="form-label-sm">QU Amount (tx amount)</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqQuAmount" /></div>
                        <div class="mb-2"><label class="form-label-sm">Asset Amount Desired</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqAssetDesired" /></div>
                        <div class="mb-2"><label class="form-label-sm">QU Amount Min</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqQuMin" /></div>
                        <div class="mb-2"><label class="form-label-sm">Asset Amount Min</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqAssetMin" /></div>
                    }
                    else
                    {
                        <div class="mb-2"><label class="form-label-sm">Burn Liquidity Amount</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqBurnAmount" /></div>
                        <div class="mb-2"><label class="form-label-sm">QU Amount Min</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqQuMin" /></div>
                        <div class="mb-2"><label class="form-label-sm">Asset Amount Min</label>
                            <input type="number" class="form-control form-control-sm" @bind="_liqAssetMin" /></div>
                    }
                    <button class="btn btn-primary" @onclick="ManageLiquidity" disabled="@_sending">
                        @(_sending ? "Processing..." : (_liqAdd ? "Add Liquidity" : "Remove Liquidity"))
                    </button>
                </div></div>
                break;

            case "Swap":
                <div class="card"><div class="card-header">Swap</div><div class="card-body">
                    <div class="mb-2"><label class="form-label-sm">Swap Type</label>
                        <select class="form-select form-select-sm" @bind="_swapType">
                            <option value="exactQuForAsset">Exact QU → Asset</option>
                            <option value="quForExactAsset">QU → Exact Asset</option>
                            <option value="exactAssetForQu">Exact Asset → QU</option>
                            <option value="assetForExactQu">Asset → Exact QU</option>
                        </select>
                    </div>
                    <AssetSelector @bind-IssuerValue="_swapIssuer" @bind-NameValue="_swapName" />
                    @switch (_swapType)
                    {
                        case "exactQuForAsset":
                            <div class="mb-2"><label class="form-label-sm">QU Amount In (tx amount)</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount1" /></div>
                            <div class="mb-2"><label class="form-label-sm">Asset Amount Out Min</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount2" /></div>
                            break;
                        case "quForExactAsset":
                            <div class="mb-2"><label class="form-label-sm">Max QU Amount In (tx amount)</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount1" /></div>
                            <div class="mb-2"><label class="form-label-sm">Exact Asset Amount Out</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount2" /></div>
                            break;
                        case "exactAssetForQu":
                            <div class="mb-2"><label class="form-label-sm">Asset Amount In</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount1" /></div>
                            <div class="mb-2"><label class="form-label-sm">QU Amount Out Min</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount2" /></div>
                            break;
                        case "assetForExactQu":
                            <div class="mb-2"><label class="form-label-sm">Max Asset Amount In</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount1" /></div>
                            <div class="mb-2"><label class="form-label-sm">Exact QU Amount Out</label>
                                <input type="number" class="form-control form-control-sm" @bind="_swapAmount2" /></div>
                            break;
                    }
                    <button class="btn btn-primary" @onclick="ExecuteSwap" disabled="@_sending">@(_sending ? "Swapping..." : "Swap")</button>
                    @if (_fees != null) { <div class="form-text">Fee: @_fees.Value.swap.ToString("N0") QU</div> }
                </div></div>
                break;
        }

        @if (_result != null)
        {
            <div class="alert alert-success mt-3">
                Transaction broadcast! Tx ID: <TxHashDisplay Hash="@_result" ShowFull="true" />
                <div class="mt-1">
                    <a href="/history">Transaction History</a>
                </div>
            </div>
            @if (_activeTab == "Transfer" && Vault.IsUnlocked && !_dismissSaveContact
                 && !string.IsNullOrEmpty(_xferNewOwner) && !Vault.IsKnownAddress(_xferNewOwner))
            {
                <div class="alert alert-info mt-2 py-2 d-flex align-items-center gap-2 flex-wrap">
                    <i class="bi bi-person-plus"></i>
                    <span class="small">Save <span class="mono">@_xferNewOwner[..12]...</span> to address book?</span>
                    <input type="text" class="form-control form-control-sm" style="width:150px"
                           @bind="_saveContactLabel" placeholder="Label" />
                    <button class="btn btn-sm btn-outline-primary" @onclick="SaveNewContact">Save</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => _dismissSaveContact = true">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            }
        }
        @if (_error != null) { <div class="alert alert-danger mt-2">@_error</div> }
    </div></div>
}

@code {
    private static readonly string[] _tabs = ["Issue", "Transfer", "Pool", "Liquidity", "Swap"];
    private string _activeTab = "Swap";
    private bool _sending;
    private string? _result;
    private string? _error;
    private const int ContractIndex = 13;
    private (uint issuance, uint pool, uint transfer, uint swap, uint burn)? _fees;

    // Issue
    private string _issueName = ""; private long _issueShares; private string _issueUnit = ""; private int _issueDecimals;
    // Transfer
    private string _xferIssuer = ""; private string _xferName = ""; private string? _xferNewOwner; private long _xferAmount;
    // Pool
    private string _poolIssuer = ""; private string _poolName = "";
    // Liquidity
    private bool _liqAdd = true; private string _liqIssuer = ""; private string _liqName = "";
    private long _liqQuAmount; private long _liqAssetDesired; private long _liqQuMin; private long _liqAssetMin; private long _liqBurnAmount;
    // Swap
    private string _swapType = "exactQuForAsset"; private string _swapIssuer = ""; private string _swapName = "";
    private long _swapAmount1; private long _swapAmount2;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await Backend.QuerySmartContractAsync(ContractIndex, 1, []);
            if (result.Length >= 32)
                _fees = (BitConverter.ToUInt32(result, 0), BitConverter.ToUInt32(result, 4),
                         BitConverter.ToUInt32(result, 8), BitConverter.ToUInt32(result, 12),
                         BitConverter.ToUInt32(result, 28));
        }
        catch { }
    }

    private async Task<uint> GetTick() => TickMonitor.IsConnected
        ? TickMonitor.Tick + (uint)Settings.TickOffset
        : (await Backend.GetTickInfoAsync()).Tick + (uint)Settings.TickOffset;

    private async Task Broadcast(long amount, uint tick, Qubic.Core.Payloads.ITransactionPayload payload, string desc)
    {
        var dest = Qubic.Core.Entities.QubicIdentity.FromPublicKey(Qubic.Core.QubicContracts.GetContractPublicKey(ContractIndex));
        var tx = Seed.CreateAndSignTransaction(dest, amount, tick, payload);
        var result = await Backend.BroadcastTransactionAsync(tx);
        _result = result.TransactionId;
        TxTracker.Track(new TrackedTransaction { Hash = result.TransactionId, Source = Seed.Identity?.ToString() ?? "",
            Destination = dest.ToString(), Amount = amount, TargetTick = tick,
            InputType = payload.InputType, PayloadHex = Convert.ToHexString(payload.GetPayloadBytes()), Description = desc,
            RawData = Convert.ToHexString(tx.GetRawBytes()) });
    }

    private byte[] ParseIssuer(string? issuer)
    {
        var err = IdentityValidation.Validate(issuer);
        if (err != null) throw new Exception("Issuer: " + err);
        return Qubic.Core.Entities.QubicIdentity.FromIdentity(issuer!.Trim()).PublicKey;
    }

    private async Task IssueAsset()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_issueName)) { _error = "Asset name is required."; return; }
            if (_issueShares <= 0) { _error = "Shares must be positive."; return; }
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Qswap.IssueAssetPayload
            {
                AssetName = AssetNameHelper.ToUlong(_issueName.Trim()),
                NumberOfShares = _issueShares,
                UnitOfMeasurement = string.IsNullOrWhiteSpace(_issueUnit) ? 0 : AssetNameHelper.ToUlong(_issueUnit.Trim()),
                NumberOfDecimalPlaces = (sbyte)_issueDecimals
            };
            await Broadcast(0, tick, payload, $"QSwap Issue: {_issueName.Trim()} ({_issueShares:N0} shares)");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task TransferAsset()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_xferName)) { _error = "Asset name required."; return; }
            if (_xferAmount <= 0) { _error = "Amount must be positive."; return; }
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Qswap.TransferShareOwnershipAndPossessionPayload
            {
                AssetIssuer = ParseIssuer(_xferIssuer),
                AssetName = AssetNameHelper.ToUlong(_xferName.Trim()),
                NewOwnerAndPossessor = ParseIssuer(_xferNewOwner),
                Amount = _xferAmount
            };
            await Broadcast(0, tick, payload, $"QSwap Transfer {_xferName.Trim()}: {_xferAmount:N0}");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task CreatePool()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_poolName)) { _error = "Asset name required."; return; }
            var tick = await GetTick();
            var payload = new Qubic.Core.Contracts.Qswap.CreatePoolPayload
            {
                AssetIssuer = ParseIssuer(_poolIssuer),
                AssetName = AssetNameHelper.ToUlong(_poolName.Trim())
            };
            await Broadcast(0, tick, payload, $"QSwap Create Pool: {_poolName.Trim()}");
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    private async Task ManageLiquidity()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_liqName)) { _error = "Asset name required."; return; }
            var tick = await GetTick();
            var issuer = ParseIssuer(_liqIssuer);
            var assetName = AssetNameHelper.ToUlong(_liqName.Trim());

            if (_liqAdd)
            {
                var payload = new Qubic.Core.Contracts.Qswap.AddLiquidityPayload
                {
                    AssetIssuer = issuer, AssetName = assetName,
                    AssetAmountDesired = _liqAssetDesired, QuAmountMin = _liqQuMin, AssetAmountMin = _liqAssetMin
                };
                await Broadcast(_liqQuAmount, tick, payload, $"QSwap Add Liquidity: {_liqQuAmount:N0} QU + {_liqAssetDesired:N0} {_liqName.Trim()}");
            }
            else
            {
                var payload = new Qubic.Core.Contracts.Qswap.RemoveLiquidityPayload
                {
                    AssetIssuer = issuer, AssetName = assetName,
                    BurnLiquidity = _liqBurnAmount, QuAmountMin = _liqQuMin, AssetAmountMin = _liqAssetMin
                };
                await Broadcast(0, tick, payload, $"QSwap Remove Liquidity: burn {_liqBurnAmount:N0}");
            }
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }

    // Save to address book
    private string? _saveContactLabel;
    private bool _dismissSaveContact;

    private void SaveNewContact()
    {
        if (string.IsNullOrWhiteSpace(_saveContactLabel) || string.IsNullOrEmpty(_xferNewOwner)) return;
        try { Vault.AddContact(_saveContactLabel, _xferNewOwner.Trim()); } catch { }
        _dismissSaveContact = true;
        _saveContactLabel = null;
    }

    private async Task ExecuteSwap()
    {
        _sending = true; _error = null; _result = null;
        try
        {
            if (string.IsNullOrWhiteSpace(_swapName)) { _error = "Asset name required."; return; }
            var tick = await GetTick();
            var issuer = ParseIssuer(_swapIssuer);
            var assetName = AssetNameHelper.ToUlong(_swapName.Trim());

            switch (_swapType)
            {
                case "exactQuForAsset":
                    await Broadcast(_swapAmount1, tick,
                        new Qubic.Core.Contracts.Qswap.SwapExactQuForAssetPayload { AssetIssuer = issuer, AssetName = assetName, AssetAmountOutMin = _swapAmount2 },
                        $"QSwap: {_swapAmount1:N0} QU → {_swapName.Trim()} (min {_swapAmount2:N0})");
                    break;
                case "quForExactAsset":
                    await Broadcast(_swapAmount1, tick,
                        new Qubic.Core.Contracts.Qswap.SwapQuForExactAssetPayload { AssetIssuer = issuer, AssetName = assetName, AssetAmountOut = _swapAmount2 },
                        $"QSwap: max {_swapAmount1:N0} QU → exact {_swapAmount2:N0} {_swapName.Trim()}");
                    break;
                case "exactAssetForQu":
                    await Broadcast(0, tick,
                        new Qubic.Core.Contracts.Qswap.SwapExactAssetForQuPayload { AssetIssuer = issuer, AssetName = assetName, AssetAmountIn = _swapAmount1, QuAmountOutMin = _swapAmount2 },
                        $"QSwap: {_swapAmount1:N0} {_swapName.Trim()} → QU (min {_swapAmount2:N0})");
                    break;
                case "assetForExactQu":
                    await Broadcast(0, tick,
                        new Qubic.Core.Contracts.Qswap.SwapAssetForExactQuPayload { AssetIssuer = issuer, AssetName = assetName, AssetAmountInMax = _swapAmount1, QuAmountOut = _swapAmount2 },
                        $"QSwap: max {_swapAmount1:N0} {_swapName.Trim()} → exact {_swapAmount2:N0} QU");
                    break;
            }
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _sending = false; }
    }
}
