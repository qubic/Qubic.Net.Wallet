@page "/logs"
@implements IDisposable
@using System.Text.Json
@inject Qubic.Services.Storage.WalletStorageService WalletStorage

<h4>Log Events</h4>
<p class="text-muted">Browse log events synced from the network for your identity.</p>

@if (!WalletStorage.IsOpen)
{
    <div class="alert alert-info">Enter your seed to open the wallet database and start syncing log events.</div>
}
else
{
    <div class="d-flex align-items-center gap-2 mb-2 small">
        @{ var logSync = WalletStorage.Sync; }
        @if (logSync.BobLogStatus is Qubic.Services.Storage.StreamStatus.Connecting or Qubic.Services.Storage.StreamStatus.CatchingUp)
        {
            <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
            <span>@(logSync.BobLogStatusMessage ?? "Syncing...")</span>
        }
        else if (logSync.BobLogStatus == Qubic.Services.Storage.StreamStatus.Error)
        {
            <i class="bi bi-exclamation-triangle-fill text-danger"></i>
            <span class="text-danger">@logSync.BobLogStatusMessage</span>
        }
        else
        {
            <i class="bi bi-check-circle text-success"></i>
            <span>@WalletStorage.LogEventCount log events</span>
            @if (logSync.BobLogStatus == Qubic.Services.Storage.StreamStatus.Live)
            {
                <span class="text-muted">(live)</span>
            }
        }
    </div>

    @* ── Filters ── *@
    <div class="d-flex gap-2 mb-3 align-items-center flex-wrap">
        <input type="number" class="form-control form-control-sm" style="width:100px" placeholder="Log type"
               @bind="_filterLogType" @bind:event="oninput" />
        <input type="number" class="form-control form-control-sm" style="width:100px" placeholder="Epoch"
               @bind="_filterEpoch" @bind:event="oninput" />
        <input type="number" class="form-control form-control-sm" style="width:120px" placeholder="Min tick"
               @bind="_filterMinTick" @bind:event="oninput" />
        <input type="number" class="form-control form-control-sm" style="width:120px" placeholder="Max tick"
               @bind="_filterMaxTick" @bind:event="oninput" />
        <input class="form-control form-control-sm" style="width:180px" placeholder="Tx hash"
               @bind="_filterTxHash" @bind:event="oninput" />
        <button class="btn btn-sm btn-primary" @onclick="LoadLogs">Filter</button>
        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">Clear</button>
    </div>

    @if (_logs == null || _logs.Count == 0)
    {
        <div class="alert alert-info">No log events found. Sync will populate this view as logs are fetched from the network.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Tick</th>
                        <th>Type</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Amount / Detail</th>
                        <th>Tx Hash</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var log in _logs)
                    {
                        var info = ParseLogInfo(log);
                        <tr>
                            <td class="small text-nowrap">@FormatTimestamp(log.Timestamp)</td>
                            <td class="mono">@log.Tick.ToString("N0")</td>
                            <td><span class="badge bg-secondary">@(log.LogTypeName ?? $"#{log.LogType}")</span></td>
                            <td>
                                @if (!string.IsNullOrEmpty(info.From))
                                {
                                    <AddressDisplay Address="@info.From" TruncateChars="6" ShowCopy="false" />
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(info.To))
                                {
                                    <AddressDisplay Address="@info.To" TruncateChars="6" ShowCopy="false" />
                                }
                            </td>
                            <td class="mono small">@info.AmountText</td>
                            <td class="mono small" style="max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                                title="@log.TxHash">
                                @if (!string.IsNullOrEmpty(log.TxHash))
                                {
                                    @log.TxHash[..12]@:...
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleDetails(log.Epoch, log.LogId)">
                                    @(IsExpanded(log.Epoch, log.LogId) ? "Hide" : "Details")
                                </button>
                            </td>
                        </tr>
                        @if (IsExpanded(log.Epoch, log.LogId))
                        {
                            <tr>
                                <td colspan="8">
                                    <div class="bg-body-secondary rounded p-3">
                                        @{ var detailInfo = ParseLogInfo(log); }
                                        <table class="table table-sm table-borderless mb-0">
                                            <tr><td class="text-muted" style="width:120px">Log ID</td><td class="mono">@log.LogId</td></tr>
                                            <tr><td class="text-muted">Tick</td><td>@log.Tick.ToString("N0")</td></tr>
                                            <tr><td class="text-muted">Epoch</td><td>@log.Epoch</td></tr>
                                            <tr><td class="text-muted">Log Type</td><td>@log.LogType</td></tr>
                                            <tr><td class="text-muted">Type Name</td><td>@(log.LogTypeName ?? "—")</td></tr>
                                            @if (!string.IsNullOrEmpty(detailInfo.From))
                                            {
                                                <tr><td class="text-muted">From</td><td><AddressDisplay Address="@detailInfo.From" ShowFull="true" /></td></tr>
                                            }
                                            @if (!string.IsNullOrEmpty(detailInfo.To))
                                            {
                                                <tr><td class="text-muted">To</td><td><AddressDisplay Address="@detailInfo.To" ShowFull="true" /></td></tr>
                                            }
                                            @if (!string.IsNullOrEmpty(detailInfo.AmountText))
                                            {
                                                <tr><td class="text-muted">Amount</td><td class="mono">@detailInfo.AmountText</td></tr>
                                            }
                                            @if (!string.IsNullOrEmpty(log.TxHash))
                                            {
                                                <tr><td class="text-muted">Tx Hash</td><td class="mono">@log.TxHash</td></tr>
                                            }
                                            @if (!string.IsNullOrEmpty(log.LogDigest))
                                            {
                                                <tr><td class="text-muted">Log Digest</td><td class="mono small">@log.LogDigest</td></tr>
                                            }
                                            <tr><td class="text-muted">Body Size</td><td>@log.BodySize bytes</td></tr>
                                            @if (!string.IsNullOrEmpty(log.Timestamp))
                                            {
                                                <tr><td class="text-muted">Timestamp</td><td>@FormatTimestamp(log.Timestamp)</td></tr>
                                            }
                                            <tr><td class="text-muted">Synced From</td><td>@log.SyncedFrom</td></tr>
                                            <tr><td class="text-muted">Synced At</td><td>@log.SyncedAtUtc</td></tr>
                                        </table>
                                        @if (!string.IsNullOrEmpty(log.Body))
                                        {
                                            <div class="mt-2">
                                                <strong class="small">Body (JSON):</strong>
                                                <pre class="bg-body border rounded p-2 small mono mt-1" style="max-height:200px; overflow:auto; white-space:pre-wrap; word-break:break-all">@log.Body</pre>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(log.BodyRaw))
                                        {
                                            <div class="mt-2">
                                                <strong class="small">Body (Raw Hex):</strong>
                                                <pre class="bg-body border rounded p-2 small mono mt-1" style="max-height:100px; overflow:auto; word-break:break-all; white-space:pre-wrap">@log.BodyRaw</pre>
                                            </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <button class="btn btn-sm btn-outline-secondary" disabled="@(_offset == 0)" @onclick="PrevPage">Prev</button>
            <span class="small text-muted">Page @(_offset / _pageSize + 1)</span>
            <button class="btn btn-sm btn-outline-secondary" disabled="@(_logs.Count < _pageSize)" @onclick="NextPage">Next</button>
        </div>
    }
}

@code {
    private List<Qubic.Services.Storage.StoredLogEvent>? _logs;
    private int? _filterLogType;
    private uint? _filterEpoch;
    private uint? _filterMinTick;
    private uint? _filterMaxTick;
    private string? _filterTxHash;
    private int _offset;
    private const int _pageSize = 50;
    private (uint Epoch, long LogId)? _expandedKey;
    private bool _disposed;

    protected override void OnInitialized()
    {
        WalletStorage.Sync.OnSyncStateChanged += OnSyncChanged;
        if (WalletStorage.IsOpen)
            LoadLogs();
    }

    private void OnSyncChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void LoadLogs()
    {
        _logs = WalletStorage.GetLogEvents(new Qubic.Services.Storage.LogEventQuery
        {
            LogType = _filterLogType,
            Epoch = _filterEpoch,
            MinTick = _filterMinTick,
            MaxTick = _filterMaxTick,
            TxHash = _filterTxHash,
            Offset = _offset,
            Limit = _pageSize
        });
    }

    private void ClearFilters()
    {
        _filterLogType = null;
        _filterEpoch = null;
        _filterMinTick = null;
        _filterMaxTick = null;
        _filterTxHash = null;
        _offset = 0;
        LoadLogs();
    }

    private void PrevPage()
    {
        _offset = Math.Max(0, _offset - _pageSize);
        LoadLogs();
    }

    private void NextPage()
    {
        _offset += _pageSize;
        LoadLogs();
    }

    private bool IsExpanded(uint epoch, long logId) => _expandedKey == (epoch, logId);

    private void ToggleDetails(uint epoch, long logId) =>
        _expandedKey = _expandedKey == (epoch, logId) ? null : (epoch, logId);

    private record LogInfo(string? From, string? To, string? AmountText);

    private LogInfo ParseLogInfo(Qubic.Services.Storage.StoredLogEvent log)
    {
        if (string.IsNullOrEmpty(log.Body)) return new(null, null, null);
        try
        {
            using var doc = JsonDocument.Parse(log.Body);
            var root = doc.RootElement;
            return log.LogType switch
            {
                0 => new(
                    GetStr(root, "from", "sourcePublicKey"),
                    GetStr(root, "to", "destinationPublicKey"),
                    $"{GetLong(root, "amount"):N0} QU"),
                1 => new(
                    GetStr(root, "issuerPublicKey", "issuer"),
                    null,
                    $"{GetLong(root, "numberOfShares"):N0} {GetStr(root, "name", "assetName") ?? "?"}"),
                2 or 3 => new(
                    GetStr(root, "from", "sourcePublicKey"),
                    GetStr(root, "to", "destinationPublicKey"),
                    $"{GetLong(root, "numberOfShares"):N0} {GetStr(root, "name", "assetName") ?? "?"}"),
                4 or 5 or 6 or 7 => new(null, null, FormatContractInfo(root, log.LogType)),
                8 => new(
                    GetStr(root, "from", "sourcePublicKey"),
                    null,
                    $"{GetLong(root, "amount"):N0} QU (burn)"),
                _ => new(null, null, null)
            };
        }
        catch { return new(null, null, null); }
    }

    private static string FormatContractInfo(JsonElement root, int logType)
    {
        var level = logType switch { 4 => "ERR", 5 => "WARN", 6 => "INFO", 7 => "DBG", _ => "?" };
        var ci = GetLong(root, "contractIndex", "_contractIndex");
        var msgType = GetLong(root, "type", "_type");
        return $"[{level}] Contract #{ci} type {msgType}";
    }

    private static string? GetStr(JsonElement root, params string[] names)
    {
        foreach (var name in names)
            if (root.TryGetProperty(name, out var prop) && prop.ValueKind == JsonValueKind.String)
                return prop.GetString();
        return null;
    }

    private static string FormatTimestamp(string? timestamp)
    {
        if (string.IsNullOrEmpty(timestamp)) return "—";
        if (long.TryParse(timestamp, out var epoch))
        {
            // Try as seconds first (typical Unix epoch), fall back to milliseconds
            var dto = epoch > 1_000_000_000_000
                ? DateTimeOffset.FromUnixTimeMilliseconds(epoch)
                : DateTimeOffset.FromUnixTimeSeconds(epoch);
            return dto.LocalDateTime.ToString("yyyy-MM-dd HH:mm:ss");
        }
        if (DateTimeOffset.TryParse(timestamp, out var parsed))
            return parsed.LocalDateTime.ToString("yyyy-MM-dd HH:mm:ss");
        return timestamp;
    }

    private static long GetLong(JsonElement root, params string[] names)
    {
        foreach (var name in names)
        {
            if (!root.TryGetProperty(name, out var prop)) continue;
            if (prop.ValueKind == JsonValueKind.Number && prop.TryGetInt64(out var v)) return v;
            if (prop.ValueKind == JsonValueKind.String && long.TryParse(prop.GetString(), out var sv)) return sv;
        }
        return 0;
    }

    public void Dispose()
    {
        _disposed = true;
        WalletStorage.Sync.OnSyncStateChanged -= OnSyncChanged;
    }
}
