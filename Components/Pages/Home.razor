@page "/"
@implements IDisposable
@inject SeedSessionService Seed
@inject QubicBackendService Backend
@inject TickMonitorService TickMonitor
@inject Qubic.Services.Storage.WalletStorageService WalletStorage
@inject TransactionTrackerService TxTracker
@inject IJSRuntime JS
@inject VaultService Vault
@inject QubicSettingsService Settings

<h4>Welcome to Qubic.Net Wallet</h4>

@if (Vault.IsUnlocked && !Seed.HasSeed)
{
    <div class="row">
        <div class="col-12">
            <h5>Select an Identity</h5>
            <p class="text-muted">Your vault is unlocked. Choose an identity to activate.</p>
        </div>
        @foreach (var entry in Vault.Entries)
        {
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-person-circle display-4 text-primary mb-2 d-block"></i>
                        <h6>@entry.Label</h6>
                        <span class="mono small text-muted">@entry.Identity[..12]...</span>
                    </div>
                    <div class="card-footer text-center">
                        <button class="btn btn-primary btn-sm" @onclick="() => ActivateFromHome(entry)">
                            <i class="bi bi-unlock me-1"></i>Activate
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else if (!Seed.HasSeed)
{
    <div class="row">
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-body text-center py-5">
                    <i class="bi bi-wallet2 display-1 text-primary mb-3 d-block"></i>
                    <h5>Get Started</h5>
                    <p class="text-muted">Enter your 55-character seed in the top bar to unlock your wallet.</p>
                    <p class="small text-muted">Your seed is stored only in memory and cleared when you close the app.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mt-3">
                <div class="card-header">Create New Wallet</div>
                <div class="card-body">
                    @if (_generatedSeed == null)
                    {
                        <p class="text-muted small">Don't have a seed yet? Generate a new one to create a wallet.</p>
                        <button class="btn btn-primary" @onclick="GenerateSeed">
                            <i class="bi bi-plus-circle me-1"></i>Generate New Seed
                        </button>
                    }
                    else
                    {
                        <div class="alert alert-danger py-2 mb-2">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>
                            <strong>Write down your seed and store it in a safe place!</strong>
                        </div>
                        <ul class="small text-muted mb-2">
                            <li>Your seed is the <strong>only key</strong> to your wallet and funds.</li>
                            <li>If you lose it, <strong>there is no recovery</strong> &mdash; your funds will be lost forever.</li>
                            <li><strong>Never share</strong> your seed with anyone. Anyone with your seed has full control over your funds.</li>
                            <li>Store it <strong>offline</strong> (paper, hardware) &mdash; not in a text file, email, or cloud storage.</li>
                        </ul>
                        <div class="mb-2">
                            <label class="form-label-sm">Your New Seed</label>
                            <div class="input-group">
                                <input type="@(_seedRevealed ? "text" : "password")" class="form-control form-control-sm mono"
                                       value="@_generatedSeed" readonly />
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => _seedRevealed = !_seedRevealed"
                                        title="@(_seedRevealed ? "Hide" : "Reveal")">
                                    <i class="bi @(_seedRevealed ? "bi-eye-slash" : "bi-eye")"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="CopyGeneratedSeed" title="Copy to clipboard">
                                    <i class="bi @(_seedCopied ? "bi-check-lg text-success" : "bi-clipboard")"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="seedSavedCheck"
                                   @bind="_seedSavedConfirmed" />
                            <label class="form-check-label small" for="seedSavedCheck">
                                I have written down my seed and stored it securely
                            </label>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @onclick="UseGeneratedSeed" disabled="@(!_seedSavedConfirmed)">
                                <i class="bi bi-unlock me-1"></i>Use This Seed
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="GenerateSeed">
                                <i class="bi bi-arrow-clockwise me-1"></i>Generate Another
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    @if (!Vault.VaultConfigured)
    {
        <div class="alert alert-info small py-2 mb-3">
            <i class="bi bi-lightbulb me-1"></i>
            <strong>Tip:</strong> You can save this seed to a password-protected vault from the toolbar above.
        </div>
    }

    @* ── Identity + Balance + Network ── *@
    <div class="card mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-5 mb-2 mb-md-0">
                    <div class="small text-muted mb-1">Identity</div>
                    <AddressDisplay Address="@Seed.Identity?.ToString()" ShowFull="true" />
                </div>
                <div class="col-md-4 mb-2 mb-md-0">
                    <div class="small text-muted mb-1">Balance</div>
                    @if (_balanceLoading)
                    {
                        <span class="text-muted"><span class="spinner-border spinner-border-sm me-1"></span> Loading...</span>
                    }
                    else if (_balance != null)
                    {
                        <h3 class="mb-0">@_balance.Value.ToString("N0") <small class="text-muted">QU</small></h3>
                    }
                    else if (_balanceError != null)
                    {
                        <span class="text-danger small">@_balanceError</span>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="LoadBalance">Load Balance</button>
                    }
                </div>
                <div class="col-md-3 text-md-end">
                    @if (TickMonitor.IsConnected)
                    {
                        <div class="small text-muted">Epoch <strong class="text-body">@TickMonitor.Epoch</strong></div>
                        <div class="small text-muted">Tick <strong class="text-body">@TickMonitor.Tick.ToString("N0")</strong></div>
                    }
                    else
                    {
                        <span class="text-muted small">Not connected</span>
                    }
                </div>
            </div>
        </div>
    </div>

    @* ── Quick Actions ── *@
    <div class="d-flex flex-wrap gap-2 mb-3">
        <a class="btn btn-primary quick-action-btn" href="/send"><i class="bi bi-send me-1"></i>Send</a>
        <a class="btn btn-outline-primary quick-action-btn" href="/receive"><i class="bi bi-qr-code me-1"></i>Receive</a>
        <a class="btn btn-outline-primary quick-action-btn" href="/assets"><i class="bi bi-grid-3x3-gap me-1"></i>Assets</a>
        <a class="btn btn-outline-primary quick-action-btn" href="/qx"><i class="bi bi-shop me-1"></i>QX Trading</a>
        <a class="btn btn-outline-primary quick-action-btn" href="/history"><i class="bi bi-list-ul me-1"></i>History</a>
    </div>

    @* ── Sync Status ── *@
    @if (WalletStorage.IsOpen)
    {
        <div class="card mb-3">
            <div class="card-body py-2">
                @{ var sync = WalletStorage.Sync; }
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    @if (sync.State == Qubic.Services.Storage.SyncState.Syncing)
                    {
                        <span class="d-flex align-items-center gap-1">
                            <span class="spinner-border spinner-border-sm text-primary"></span>
                            <span class="small">Syncing...</span>
                        </span>
                    }
                    else
                    {
                        <span class="small text-muted"><strong class="text-body">@WalletStorage.TransactionCount</strong> transactions, <strong class="text-body">@WalletStorage.LogEventCount</strong> log events</span>
                    }
                    <span class="small">@StreamIcon(sync.RpcStatus) RPC: <span class="text-muted">@(sync.RpcStatusMessage ?? "Idle")</span></span>
                    <span class="small">@StreamIcon(sync.BobLogStatus) Logs: <span class="text-muted">@(sync.BobLogStatusMessage ?? "Idle")</span></span>
                    @if (sync.LastError != null)
                    {
                        <span class="text-danger small"><i class="bi bi-exclamation-triangle me-1"></i>@sync.LastError</span>
                    }
                </div>
            </div>
        </div>
    }

    @* ── Assets & Orders ── *@
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Owned Assets</span>
                    <a class="btn btn-sm btn-outline-primary" href="/assets">View All</a>
                </div>
                <div class="card-body">
                    @if (_assetsLoading)
                    {
                        <span class="text-muted"><span class="spinner-border spinner-border-sm me-1"></span> Loading assets...</span>
                    }
                    else if (_ownedAssets != null && _ownedAssets.Any(a => a.Data.NumberOfUnits != "0"))
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr><th>Asset</th><th>Shares</th><th>Contract</th></tr>
                                </thead>
                                <tbody>
                                    @foreach (var a in _ownedAssets.Where(a => a.Data.NumberOfUnits != "0"))
                                    {
                                        <tr>
                                            <td class="mono">@(a.Data.IssuedAsset?.Name ?? "?")</td>
                                            <td class="mono">@a.Data.NumberOfUnits</td>
                                            <td>@Qubic.Core.QubicContracts.FormatContract((int)a.Data.ManagingContractIndex)</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (_assetsError != null)
                    {
                        <span class="text-danger small">@_assetsError</span>
                    }
                    else
                    {
                        <span class="text-muted">No owned assets.</span>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Open QX Orders</span>
                    <a class="btn btn-sm btn-outline-primary" href="/qx">View All</a>
                </div>
                <div class="card-body">
                    @if (_ordersLoading)
                    {
                        <span class="text-muted"><span class="spinner-border spinner-border-sm me-1"></span> Loading orders...</span>
                    }
                    else if ((_askOrders != null && _askOrders.Count > 0) || (_bidOrders != null && _bidOrders.Count > 0))
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr><th>Type</th><th>Asset</th><th>Price</th><th>Shares</th></tr>
                                </thead>
                                <tbody>
                                    @if (_askOrders != null)
                                    {
                                        @foreach (var o in _askOrders)
                                        {
                                            <tr>
                                                <td><span class="badge-qb-danger">Ask</span></td>
                                                <td class="mono">@(Qubic.Core.AssetNameHelper.FromUlong(o.AssetName) ?? "?")</td>
                                                <td class="mono">@o.Price.ToString("N0")</td>
                                                <td class="mono">@o.NumberOfShares.ToString("N0")</td>
                                            </tr>
                                        }
                                    }
                                    @if (_bidOrders != null)
                                    {
                                        @foreach (var o in _bidOrders)
                                        {
                                            <tr>
                                                <td><span class="badge-qb-success">Bid</span></td>
                                                <td class="mono">@(Qubic.Core.AssetNameHelper.FromUlong(o.AssetName) ?? "?")</td>
                                                <td class="mono">@o.Price.ToString("N0")</td>
                                                <td class="mono">@o.NumberOfShares.ToString("N0")</td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else if (_ordersError != null)
                    {
                        <span class="text-danger small">@_ordersError</span>
                    }
                    else
                    {
                        <span class="text-muted">No open orders.</span>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    private long? _balance;
    private bool _balanceLoading;
    private string? _balanceError;
    private bool _disposed;

    // Seed generation
    private string? _generatedSeed;
    private bool _seedRevealed;
    private bool _seedCopied;
    private bool _seedSavedConfirmed;

    // Owned assets
    private IReadOnlyList<Qubic.Rpc.Models.OwnedAssetInfo>? _ownedAssets;
    private bool _assetsLoading;
    private string? _assetsError;

    // QX orders
    private List<Qubic.Core.Contracts.Qx.EntityAskOrdersOrder>? _askOrders;
    private List<Qubic.Core.Contracts.Qx.EntityBidOrdersOrder>? _bidOrders;
    private bool _ordersLoading;
    private string? _ordersError;

    protected override async Task OnInitializedAsync()
    {
        TickMonitor.OnTickChanged += OnTickChanged;
        Seed.OnSeedChanged += OnSeedChanged;
        WalletStorage.Sync.OnSyncStateChanged += OnSyncChanged;

        if (Seed.HasSeed)
        {
            var balanceTask = LoadBalance();
            var assetsTask = LoadAssets();
            var ordersTask = LoadOrders();
            await Task.WhenAll(balanceTask, assetsTask, ordersTask);
        }
    }

    private void OnTickChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnSyncChanged()
    {
        if (_disposed) return;
        InvokeAsync(() => { if (!_disposed) StateHasChanged(); });
    }

    private void OnSeedChanged()
    {
        if (_disposed) return;
        InvokeAsync(async () =>
        {
            if (_disposed) return;
            _balance = null;
            _balanceError = null;
            _ownedAssets = null;
            _assetsError = null;
            _askOrders = null;
            _bidOrders = null;
            _ordersError = null;
            if (Seed.HasSeed)
            {
                var t1 = LoadBalance();
                var t2 = LoadAssets();
                var t3 = LoadOrders();
                await Task.WhenAll(t1, t2, t3);
            }
            StateHasChanged();
        });
    }

    private async Task LoadBalance()
    {
        if (!Seed.HasSeed || Seed.Identity == null) return;
        _balanceLoading = true;
        _balanceError = null;
        StateHasChanged();
        try
        {
            var bal = await Backend.GetBalanceAsync(Seed.Identity.Value);
            _balance = bal.Amount;
        }
        catch (Exception ex)
        {
            _balanceError = ex.Message;
        }
        finally
        {
            _balanceLoading = false;
        }
    }

    private async Task LoadAssets()
    {
        if (!Seed.HasSeed || Seed.Identity == null) return;
        _assetsLoading = true;
        _assetsError = null;
        try
        {
            _ownedAssets = await Backend.GetOwnedAssetsAsync(Seed.Identity.Value);
        }
        catch (Exception ex)
        {
            _assetsError = ex.Message;
        }
        finally
        {
            _assetsLoading = false;
        }
    }

    private async Task LoadOrders()
    {
        if (!Seed.HasSeed || Seed.Identity == null) return;
        _ordersLoading = true;
        _ordersError = null;
        try
        {
            var pk = Seed.Identity.Value.PublicKey;

            var askInput = new Qubic.Core.Contracts.Qx.EntityAskOrdersInput { Entity = pk, Offset = 0 }.ToBytes();
            var bidInput = new Qubic.Core.Contracts.Qx.EntityBidOrdersInput { Entity = pk, Offset = 0 }.ToBytes();

            var askTask = Backend.QuerySmartContractAsync(1, 4, askInput);
            var bidTask = Backend.QuerySmartContractAsync(1, 5, bidInput);
            await Task.WhenAll(askTask, bidTask);

            var askResult = askTask.Result;
            if (askResult.Length >= Qubic.Core.Contracts.Qx.EntityAskOrdersOrder.Size)
            {
                var output = Qubic.Core.Contracts.Qx.EntityAskOrdersOutput.FromBytes(askResult);
                _askOrders = output.Orders.Where(o => o.NumberOfShares > 0).ToList();
            }

            var bidResult = bidTask.Result;
            if (bidResult.Length >= Qubic.Core.Contracts.Qx.EntityBidOrdersOrder.Size)
            {
                var output = Qubic.Core.Contracts.Qx.EntityBidOrdersOutput.FromBytes(bidResult);
                _bidOrders = output.Orders.Where(o => o.NumberOfShares > 0).ToList();
            }
        }
        catch (Exception ex)
        {
            _ordersError = ex.Message;
        }
        finally
        {
            _ordersLoading = false;
        }
    }

    private static MarkupString StreamIcon(Qubic.Services.Storage.StreamStatus status) => status switch
    {
        Qubic.Services.Storage.StreamStatus.Connecting or Qubic.Services.Storage.StreamStatus.CatchingUp =>
            new MarkupString("<span class=\"spinner-border spinner-border-sm text-primary\" style=\"width:.7em;height:.7em\"></span>"),
        Qubic.Services.Storage.StreamStatus.Live =>
            new MarkupString("<i class=\"bi bi-check-circle-fill text-success\"></i>"),
        Qubic.Services.Storage.StreamStatus.Error =>
            new MarkupString("<i class=\"bi bi-exclamation-triangle-fill text-danger\"></i>"),
        _ => new MarkupString("<i class=\"bi bi-circle text-muted\"></i>"),
    };

    private void GenerateSeed()
    {
        var chars = new char[55];
        Span<byte> random = stackalloc byte[55];
        System.Security.Cryptography.RandomNumberGenerator.Fill(random);
        for (int i = 0; i < 55; i++)
            chars[i] = (char)('a' + (random[i] % 26));
        _generatedSeed = new string(chars);
        _seedRevealed = false;
        _seedCopied = false;
        _seedSavedConfirmed = false;
    }

    private async Task CopyGeneratedSeed()
    {
        if (_generatedSeed == null) return;
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", _generatedSeed);
        _seedCopied = true;
        StateHasChanged();
        await Task.Delay(2000);
        _seedCopied = false;
    }

    private void ActivateFromHome(VaultEntry entry)
    {
        try
        {
            Seed.SetSeed(entry.Seed, entry.Label);
            WalletStorage.SetSeed(entry.Seed, entry.Identity, TickMonitor.Epoch);
            TxTracker.SetEncryptionKey(entry.Seed);
            Settings.SetCustom("vault_last_identity", entry.Identity);
        }
        catch { }
    }

    private void UseGeneratedSeed()
    {
        if (_generatedSeed == null || !_seedSavedConfirmed) return;
        try
        {
            Seed.SetSeed(_generatedSeed);
            WalletStorage.SetSeed(_generatedSeed, Seed.Identity!.Value.ToString(), TickMonitor.Epoch);
            TxTracker.SetEncryptionKey(_generatedSeed);
            _generatedSeed = null;
            _seedSavedConfirmed = false;
        }
        catch { }
    }

    public void Dispose()
    {
        _disposed = true;
        TickMonitor.OnTickChanged -= OnTickChanged;
        Seed.OnSeedChanged -= OnSeedChanged;
        WalletStorage.Sync.OnSyncStateChanged -= OnSyncChanged;
    }
}
